<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifactura · Extracción y validación de facturas vehiculares</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        --accent: #2563eb;
        --accent-dark: #1e40af;
        --accent-soft: rgba(37, 99, 235, 0.12);
        --border: #e2e8f0;
        --border-strong: #cbd5f5;
        --text: #0f172a;
        --muted: #64748b;
        --surface: #ffffff;
        --surface-subtle: #f8fafc;
        --danger: #dc2626;
        --danger-soft: rgba(220, 38, 38, 0.12);
        background: var(--surface);
        color: var(--text);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--surface);
        color: var(--text);
      }

      body:not(.developer-mode) [data-developer-only] {
        display: none !important;
      }

      h1,
      h2,
      h3,
      p {
        margin: 0;
      }

      button {
        font: inherit;
        cursor: pointer;
      }

      .app-shell {
        min-height: 100vh;
        padding: clamp(2.5rem, 4vw, 4rem) clamp(1.5rem, 6vw, 5rem) 3rem;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 100%;
      }

      .header-bar {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: clamp(1.5rem, 4vw, 3rem);
        flex-wrap: wrap;
      }

      .header-text {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        flex: 1 1 64rem;
        min-width: 0;
        max-width: 100%;
      }

      .header-extra {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 1rem;
        flex-shrink: 0;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .hero-title {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        gap: 0.5rem;
        font-size: clamp(1.85rem, 3.2vw, 3rem);
        font-weight: 600;
        letter-spacing: -0.02em;
        color: var(--text);
        max-width: 100%;
      }

      .hero-title__text {
        flex: 0 1 auto;
        min-width: 0;
      }

      .hero-subtitle {
        color: var(--muted);
        font-size: 1rem;
        line-height: 1.6;
        max-width: 100%;
      }

      .hero-logo {
        width: clamp(180px, 18vw, 240px);
        height: auto;
        display: block;
      }

      .developer-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-size: 0.85rem;
        font-weight: 500;
        flex-shrink: 0;
      }

      .developer-badge[hidden] {
        display: none !important;
      }

      .header-restore[hidden] {
        display: none !important;
      }

      .header-restore {
        align-self: flex-start;
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 0.5rem 1.1rem;
        font-weight: 500;
        color: var(--accent);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .header-restore:hover,
      .header-restore:focus-visible {
        border-color: var(--accent);
        color: var(--accent-dark);
        box-shadow: 0 0 0 3px var(--accent-soft);
        outline: none;
      }

      .settings-button {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 0.5rem 1.1rem;
        font-weight: 500;
        color: var(--muted);
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .settings-button:hover,
      .settings-button:focus-visible {
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        outline: none;
      }

      .workspace {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        gap: 2rem;
        align-items: flex-start;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 1.5rem;
        padding: clamp(1.75rem, 2vw, 2.25rem);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        box-shadow: 0 28px 60px -40px rgba(15, 23, 42, 0.3);
      }

      .panel h2 {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text);
      }

      .panel--input {
        position: relative;
      }

      .panel-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
      }

      .panel-header__text {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .panel-body {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .llm-provider-row,
      .ocr-provider-row {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem;
        border-radius: 1rem;
        border: 1px dashed var(--border);
        background: var(--surface-subtle);
      }

      .llm-provider-row label,
      .ocr-provider-row label {
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        color: var(--text);
      }

      .llm-provider-row label span,
      .ocr-provider-row label span {
        font-weight: 400;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .llm-provider-row select,
      .ocr-provider-row select {
        appearance: none;
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        padding: 0.6rem 0.75rem;
        font-size: 0.95rem;
        background: var(--surface);
        color: var(--text);
      }

      .llm-provider-row select:focus-visible,
      .ocr-provider-row select:focus-visible {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .llm-settings {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        border-radius: 1rem;
        border: 1px dashed var(--border);
        background: var(--surface-subtle);
      }

      .llm-settings__section {
        display: grid;
        gap: 1rem;
      }

      .ocr-settings {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        border-radius: 1rem;
        border: 1px dashed var(--border);
        background: var(--surface-subtle);
      }

      .ocr-settings__fields {
        display: grid;
        gap: 1rem;
      }

      .ocr-settings__fields[hidden] {
        display: none !important;
      }

      .llm-settings__section[hidden] {
        display: none !important;
      }

      .llm-settings__grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .llm-settings__row {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .llm-field {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.85rem;
        border-radius: 1rem;
        border: 1px solid var(--border);
        background: var(--surface);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .llm-field:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .llm-field.is-disabled {
        opacity: 0.6;
      }

      .llm-field__heading {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .llm-field__text {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .llm-field__text label {
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
      }

      .llm-field__text span {
        font-weight: 400;
        color: var(--muted);
        font-size: 0.8rem;
      }

      .llm-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 500;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .llm-toggle input {
        width: 1.1rem;
        height: 1.1rem;
        accent-color: var(--accent);
      }

      .llm-settings select,
      .llm-settings input[type="number"],
      .llm-settings input[type="text"],
      .llm-settings input[type="password"] {
        appearance: none;
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        padding: 0.6rem 0.75rem;
        font-size: 0.95rem;
        background: var(--surface);
        color: var(--text);
      }

      .llm-settings select:focus-visible,
      .llm-settings input[type="number"]:focus-visible,
      .llm-settings input[type="text"]:focus-visible,
      .llm-settings input[type="password"]:focus-visible {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .panel-toggle {
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .panel-toggle:hover,
      .panel-toggle:focus-visible {
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        outline: none;
      }

      .panel-toggle span[aria-hidden="true"] {
        font-size: 1rem;
      }

      .segmented-control {
        display: inline-flex;
        align-self: flex-start;
        background: var(--surface-subtle);
        border-radius: 999px;
        padding: 0.25rem;
        border: 1px solid var(--border);
        gap: 0.25rem;
      }

      .segmented-control button {
        border: none;
        padding: 0.5rem 1.1rem;
        border-radius: 999px;
        color: var(--muted);
        background: transparent;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }

      .segmented-control button.active {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 10px 22px -16px rgba(37, 99, 235, 0.8);
      }

      .drop-zone {
        border: 1.5px dashed var(--border);
        border-radius: 1.25rem;
        padding: clamp(2rem, 4vw, 2.75rem);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.25rem;
        text-align: center;
        background: var(--surface-subtle);
        transition: border-color 0.2s ease, background 0.2s ease;
        position: relative;
      }

      .drop-zone.dragging {
        border-color: var(--accent);
        background: var(--accent-soft);
      }

      .drop-zone__icon {
        width: 64px;
        height: 64px;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0));
        display: grid;
        place-items: center;
        color: var(--accent);
        font-size: 1.75rem;
      }

      .drop-zone strong {
        font-size: 1.05rem;
      }

      .drop-zone p {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .drop-zone button {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 500;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .drop-zone button:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .file-details {
        display: grid;
        gap: 1.25rem;
        margin-top: 1.5rem;
      }

      .file-meta {
        display: grid;
        gap: 0.75rem;
        font-size: 0.9rem;
      }

      .file-meta div {
        display: flex;
        align-items: baseline;
        gap: 0.35rem;
      }

      .file-meta span {
        color: var(--muted);
      }

      .file-meta strong {
        color: var(--text);
      }

      .preview {
        background: var(--surface-subtle);
        border: 1px solid var(--border);
        border-radius: 1.1rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .preview h3 {
        font-size: 1rem;
        font-weight: 600;
      }

      .preview-action {
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--accent);
        font-size: 0.85rem;
        font-weight: 500;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .preview-action:hover,
      .preview-action:focus-visible {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        color: var(--accent-dark);
        outline: none;
      }

      .preview-content {
        max-height: 320px;
        overflow: auto;
        border-radius: 0.75rem;
        background: var(--surface);
        border: 1px solid var(--border);
      }

      .preview-placeholder {
        margin: 0;
        padding: 1.25rem;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .preview-content iframe,
      .preview-content embed {
        width: 100%;
        height: 320px;
        border: none;
        border-radius: inherit;
      }

      .preview-content img {
        max-width: 100%;
        display: block;
        border-radius: inherit;
      }

      .preview-content pre {
        margin: 0;
        padding: 1rem;
        font-family: "IBM Plex Mono", "Fira Code", monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        line-height: 1.5;
      }

      .preview-highlight {
        background: rgba(37, 99, 235, 0.24);
        border-radius: 0.35rem;
        padding: 0.05rem 0.2rem;
        transition: background-color 0.2s ease;
        position: relative;
      }

      .preview-highlight:hover {
        background: rgba(37, 99, 235, 0.35);
      }

      .preview-highlight[data-field]::after {
        content: attr(data-field);
        position: absolute;
        left: 50%;
        transform: translate(-50%, -120%);
        background: var(--accent);
        color: var(--surface);
        font-size: 0.7rem;
        padding: 0.15rem 0.45rem;
        border-radius: 0.35rem;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        box-shadow: 0 10px 25px -12px rgba(15, 23, 42, 0.45);
        z-index: 2;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .preview-highlight[data-field]:hover::after {
        opacity: 1;
        transform: translate(-50%, -160%);
      }

      .preview-hint {
        margin: 0;
        padding: 1.25rem 1.25rem 0.5rem;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .preview-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        background: rgba(15, 23, 42, 0.65);
        z-index: 1000;
      }

      .preview-modal[hidden] {
        display: none;
      }

      .preview-modal__dialog {
        width: min(960px, 95vw);
        max-height: 90vh;
        background: var(--surface);
        border-radius: 1.25rem;
        border: 1px solid var(--border);
        box-shadow: 0 40px 90px -45px rgba(15, 23, 42, 0.55);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .preview-modal__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
      }

      .preview-modal__header h3 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
      }

      .preview-modal__close {
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 1.75rem;
        line-height: 1;
        padding: 0.25rem;
        cursor: pointer;
        border-radius: 0.5rem;
      }

      .preview-modal__close:hover,
      .preview-modal__close:focus-visible {
        color: var(--text);
        background: var(--surface-subtle);
        outline: none;
      }

      .preview-modal__body {
        flex: 1;
        overflow: auto;
        background: var(--surface);
        padding: 0;
      }

      .preview-modal__body iframe,
      .preview-modal__body embed {
        width: 100%;
        min-height: 70vh;
        border: none;
      }

      .preview-modal__body img {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        height: auto;
      }

      .preview-modal__body pre {
        margin: 0;
        padding: 1.25rem;
        font-family: "IBM Plex Mono", "Fira Code", monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      body.modal-open {
        overflow: hidden;
      }

      .multi-details {
        display: grid;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .multi-summary {
        font-size: 0.9rem;
        display: inline-flex;
        align-items: baseline;
        gap: 0.35rem;
        color: var(--muted);
      }

      .multi-summary strong {
        color: var(--text);
      }

      .multi-file-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.75rem;
      }

      .multi-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        background: var(--surface-subtle);
        border: 1px solid var(--border);
      }

      .multi-file-item span {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.9rem;
      }

      .multi-file-item small {
        color: var(--muted);
      }

      .multi-file-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .multi-file-item button.remove-button {
        border: none;
        background: transparent;
        color: var(--danger);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
      }

      .multi-file-item button.remove-button:hover,
      .multi-file-item button.remove-button:focus-visible {
        color: #b91c1c;
        outline: none;
      }

      textarea {
        width: 100%;
        border-radius: 1rem;
        border: 1px solid var(--border);
        min-height: 220px;
        padding: 1rem;
        font: inherit;
        line-height: 1.5;
        background: var(--surface-subtle);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        background: var(--surface);
      }

      .helper-text {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .toggle input[type="checkbox"] {
        appearance: none;
        width: 44px;
        height: 24px;
        border-radius: 999px;
        background: var(--border);
        position: relative;
        transition: background 0.25s ease;
      }

      .toggle input[type="checkbox"]::after {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
        transition: transform 0.25s ease;
      }

      .toggle input[type="checkbox"]:checked {
        background: var(--accent);
      }

      .toggle input[type="checkbox"]:checked::after {
        transform: translateX(20px);
      }

      .submit-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .primary {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 1rem;
        padding: 0.85rem 1.8rem;
        font-weight: 600;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }

      .primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px -20px rgba(37, 99, 235, 0.8);
      }

      .secondary {
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        border-radius: 1rem;
        padding: 0.8rem 1.2rem;
        font-weight: 500;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      .secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .status {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .status.error {
        color: var(--danger);
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .results-header p {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .download-group {
        display: inline-flex;
        gap: 0.5rem;
      }

      .download-group button {
        border-radius: 0.9rem;
        padding: 0.65rem 1.1rem;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        font-weight: 500;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      .download-group button:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
      }

      .download-group button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .results-navigation {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        justify-content: flex-end;
      }

      .results-navigation button {
        border: none;
        background: var(--surface-subtle);
        color: var(--accent);
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        font-weight: 500;
      }

      .result-meta {
        font-size: 0.9rem;
        color: var(--muted);
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .result-meta strong {
        color: var(--text);
      }

      .results-grid {
        display: grid;
        gap: 1rem;
        max-height: 60vh;
        overflow: auto;
        padding-right: 0.25rem;
      }

      .results-grid.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 0.95rem;
        text-align: center;
      }

      .workspace--input-hidden {
        grid-template-columns: minmax(0, 1fr);
      }

      .workspace--input-hidden .panel--input {
        display: none;
      }

      .panel--preview {
        display: none;
      }

      .workspace--input-hidden.workspace--with-preview {
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      }

      .workspace--input-hidden.workspace--with-preview .panel--preview {
        display: flex;
      }

      .panel-body--preview {
        gap: 1rem;
        flex: 1;
      }

      .panel-body--preview .preview-content {
        max-height: 60vh;
        flex: 1;
      }

      .settings-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(2px);
        z-index: 300;
      }

      .settings-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: min(320px, 90vw);
        height: 100vh;
        background: var(--surface);
        border-left: 1px solid var(--border);
        box-shadow: -30px 0 60px -40px rgba(15, 23, 42, 0.35);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.25s ease;
        z-index: 400;
      }

      .settings-panel[aria-hidden="false"] {
        transform: translateX(0);
      }

      .settings-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
      }

      .settings-panel__header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .settings-close {
        border: none;
        background: transparent;
        font-size: 1.5rem;
        color: var(--muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.5rem;
      }

      .settings-close:hover,
      .settings-close:focus-visible {
        color: var(--text);
        background: var(--surface-subtle);
        outline: none;
      }

      .settings-panel__body {
        padding: 1.25rem 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        overflow-y: auto;
      }

      .settings-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .settings-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        font-size: 0.95rem;
      }

      .settings-option label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-weight: 500;
      }

      .settings-option span {
        color: var(--muted);
        font-size: 0.85rem;
        font-weight: 400;
      }

      .settings-option input[type="checkbox"] {
        width: 46px;
        height: 24px;
      }

      .settings-option select {
        border-radius: 0.75rem;
        border: 1px solid var(--border);
        padding: 0.45rem 0.75rem;
        background: var(--surface-subtle);
        font: inherit;
      }

      body.theme-dark {
        color-scheme: dark;
        --surface: #0f172a;
        --surface-subtle: #16213c;
        --border: rgba(148, 163, 184, 0.25);
        --border-strong: rgba(148, 163, 184, 0.45);
        --text: #e2e8f0;
        --muted: #cbd5f5;
        background: var(--surface);
        color: var(--text);
      }

      body.theme-dark header h1,
      body.theme-dark header p,
      body.theme-dark .panel h2,
      body.theme-dark .panel-header__text p,
      body.theme-dark .multi-summary,
      body.theme-dark .multi-file-item span,
      body.theme-dark .multi-file-item strong,
      body.theme-dark .settings-button {
        color: var(--text);
      }

      body.theme-dark .settings-button {
        border-color: var(--border-strong);
      }

      .progress-row {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 0.75rem 1rem;
      }

      .progress-row__meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .progress-track {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: var(--surface-subtle);
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        width: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        transition: width 0.3s ease;
      }

      .result-field {
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 0.9rem 1rem;
        background: var(--surface-subtle);
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .result-field label {
        font-weight: 600;
        font-size: 0.92rem;
        color: var(--text);
      }

      .result-field .value {
        font-size: 0.9rem;
        color: var(--text);
        word-break: break-word;
      }

      .result-field .value.missing {
        color: var(--danger);
        border-radius: 0.75rem;
        border: 1px dashed var(--danger);
        background: var(--danger-soft);
        padding: 0.65rem 0.75rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.06);
        color: var(--muted);
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
      }

      @media (min-width: 1400px) {
        .hero-title__text {
          white-space: nowrap;
        }
      }

      @media (max-width: 1024px) {
        .header-bar {
          flex-wrap: wrap;
        }

        .header-text {
          flex-basis: 100%;
          min-width: 100%;
        }

        .header-extra {
          align-items: flex-start;
          width: 100%;
        }
      }

      @media (max-width: 760px) {
        .app-shell {
          padding: 2rem 1.25rem 3rem;
        }

        .header-extra {
          align-items: flex-start;
          width: 100%;
        }

        .header-actions {
          align-self: flex-start;
        }

        .results-navigation {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div class="header-bar">
          <div class="header-text">
            <h1 class="hero-title">
              <span class="hero-title__text"
                >Verifactura · Extracción y validación de facturas vehiculares</span
              >
              <span class="developer-badge" id="developerBadge" hidden
                >Modo desarrollador</span
              >
            </h1>
            <p class="hero-subtitle">
              Carga tus comprobantes y obtén campos normalizados y validados con reglas
              SRI y VIN.
            </p>
            <button
              type="button"
              id="showInputPanelButton"
              class="header-restore"
              hidden
              aria-hidden="true"
            >
              Mostrar carga de facturas
            </button>
          </div>
          <div class="header-extra">
            <div class="header-actions">
              <button
                type="button"
                id="settingsButton"
                class="settings-button"
                aria-haspopup="dialog"
                aria-expanded="false"
              >
                Ajustes
              </button>
            </div>
            <img
              src="{{ request.url_for('static', path='verifactura-logo.svg') }}"
              alt="VeriFactura"
              class="hero-logo"
            />
          </div>
        </div>
      </header>

      <div class="workspace">
        <section class="panel panel--input" aria-labelledby="inputHeading" id="inputPanel">
          <div class="panel-header">
            <div class="panel-header__text">
              <h2 id="inputHeading">Carga de facturas</h2>
              <p class="helper-text">
                Formatos admitidos: PDF, XML, JSON, PNG, JPG, JPEG, TIF, TIFF.
              </p>
            </div>
            <button
              type="button"
              class="panel-toggle"
              id="hideInputPanelButton"
              aria-label="Ocultar sección de carga"
              aria-pressed="false"
            >
              Ocultar
            </button>
          </div>

          <div class="panel-body" id="inputPanelBody">
            <div
              class="llm-provider-row"
              id="llmProviderRow"
              hidden
              aria-hidden="true"
              data-developer-only
            >
              <label for="llmProviderSelect">
                Proveedor LLM
                <span
                  >Elige entre el servicio API y el modelo local (GPT OSS 20B).</span
                >
              </label>
              <select id="llmProviderSelect">
                <option value="api">Servicio API</option>
                <option value="local">Servicio local (GPT OSS 20B)</option>
              </select>
            </div>
            <div
              class="llm-settings"
              id="llmSettings"
              hidden
              aria-hidden="true"
              data-developer-only
            >
              <div
                class="llm-settings__section"
                data-llm-provider-settings="api"
                hidden
                aria-hidden="true"
              >
                <div class="llm-settings__grid">
                  <div class="llm-field" data-developer-only>
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiModel">
                          Modelo (API)
                          <span>
                            Personaliza el identificador del modelo para el servicio
                            API.
                          </span>
                        </label>
                      </div>
                    </div>
                    <input
                      id="llmApiModel"
                      type="text"
                      list="llmApiModelOptions"
                      value="{{ llm_defaults.api.model }}"
                    />
                    <datalist id="llmApiModelOptions">
                      {% for option in llm_defaults.api.options %}
                      <option value="{{ option }}"></option>
                      {% endfor %}
                    </datalist>
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiTemperature">
                          Temperatura
                          <span>Controla la aleatoriedad de las respuestas.</span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmApiTemperatureEnabled">
                        <input
                          type="checkbox"
                          id="llmApiTemperatureEnabled"
                        />
                        <span>Activado</span>
                      </label>
                    </div>
                    <input
                      id="llmApiTemperature"
                      type="number"
                      min="0"
                      max="2"
                      step="0.1"
                      value="1"
                    />
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiTopP">
                          Top-p
                          <span>Limita la probabilidad acumulada del muestreo.</span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmApiTopPEnabled">
                        <input type="checkbox" id="llmApiTopPEnabled" />
                        <span>Activado</span>
                      </label>
                    </div>
                    <input
                      id="llmApiTopP"
                      type="number"
                      min="0"
                      max="1"
                      step="0.05"
                      value="1"
                    />
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiReasoningEffort">
                          Razonamiento
                          <span>Ajusta el esfuerzo de razonamiento solicitado.</span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmApiReasoningEnabled">
                        <input type="checkbox" id="llmApiReasoningEnabled" />
                        <span>Activado</span>
                      </label>
                    </div>
                    <select id="llmApiReasoningEffort">
                      <option value="minimal">Mínimo</option>
                      <option value="low">Bajo</option>
                      <option value="medium">Medio</option>
                      <option value="high">Alto</option>
                    </select>
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiFrequencyPenalty">
                          Frecuencia
                          <span>
                            Penaliza repeticiones del modelo (-2 a 2).
                          </span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmApiFrequencyEnabled">
                        <input
                          type="checkbox"
                          id="llmApiFrequencyEnabled"
                        />
                        <span>Activado</span>
                      </label>
                    </div>
                    <input
                      id="llmApiFrequencyPenalty"
                      type="number"
                      min="-2"
                      max="2"
                      step="0.1"
                      value="0"
                    />
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiPresencePenalty">
                          Presencia
                          <span>Reduce repeticiones temáticas (-2 a 2).</span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmApiPresenceEnabled">
                        <input
                          type="checkbox"
                          id="llmApiPresenceEnabled"
                        />
                        <span>Activado</span>
                      </label>
                    </div>
                    <input
                      id="llmApiPresencePenalty"
                      type="number"
                      min="-2"
                      max="2"
                      step="0.1"
                      value="0"
                    />
                  </div>
                </div>
                <div class="llm-settings__row">
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmApiKey">
                          OpenAI API Key
                          <span>
                            Se usará para esta sesión cuando el servicio API esté
                            activo.
                          </span>
                        </label>
                      </div>
                    </div>
                    <input
                      id="llmApiKey"
                      type="password"
                      placeholder="sk-..."
                      autocomplete="off"
                    />
                  </div>
                </div>
              </div>
              <div
                class="llm-settings__section"
                data-llm-provider-settings="local"
                hidden
                aria-hidden="true"
              >
                <div class="llm-settings__grid">
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmLocalModel">
                          Modelo local
                          <span>
                            Indica la ruta o identificador del modelo que deseas
                            cargar.
                          </span>
                        </label>
                      </div>
                    </div>
                    <input
                      id="llmLocalModel"
                      type="text"
                      list="llmLocalModelOptions"
                      value="{{ llm_defaults.local.model }}"
                    />
                    <datalist id="llmLocalModelOptions">
                      {% for option in llm_defaults.local.options %}
                      <option value="{{ option }}"></option>
                      {% endfor %}
                    </datalist>
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmLocalTemperature">
                          Temperatura
                          <span>Ajusta la creatividad del modelo local.</span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmLocalTemperatureEnabled">
                        <input
                          type="checkbox"
                          id="llmLocalTemperatureEnabled"
                        />
                        <span>Activado</span>
                      </label>
                    </div>
                    <input
                      id="llmLocalTemperature"
                      type="number"
                      min="0"
                      max="2"
                      step="0.1"
                      value="1"
                    />
                  </div>
                  <div class="llm-field">
                    <div class="llm-field__heading">
                      <div class="llm-field__text">
                        <label for="llmLocalTopP">
                          Top-p
                          <span>
                            Configura el muestreo nucleus del modelo local.
                          </span>
                        </label>
                      </div>
                      <label class="llm-toggle" for="llmLocalTopPEnabled">
                        <input type="checkbox" id="llmLocalTopPEnabled" />
                        <span>Activado</span>
                      </label>
                    </div>
                    <input
                      id="llmLocalTopP"
                      type="number"
                      min="0"
                      max="1"
                      step="0.05"
                      value="1"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="ocr-settings" id="ocrSettings" data-developer-only hidden aria-hidden="true">
              <div class="ocr-provider-row">
                <label for="ocrProviderSelect">
                  Proveedor OCR
                  <span>
                    Selecciona el servicio para el reconocimiento óptico de
                    caracteres.
                  </span>
                </label>
                <select id="ocrProviderSelect">
                  <option value="azure-vision" selected>Azure Vision</option>
                </select>
              </div>
              <div
                class="ocr-settings__fields"
                data-ocr-provider="azure-vision"
                hidden
                aria-hidden="true"
              >
                <div class="llm-field">
                  <div class="llm-field__heading">
                    <div class="llm-field__text">
                      <label for="ocrAzureEndpoint">
                        AZURE_FORM_RECOGNIZER_ENDPOINT
                        <span>
                          Introduce el endpoint de Azure Form Recognizer.
                        </span>
                      </label>
                    </div>
                  </div>
                  <input
                    id="ocrAzureEndpoint"
                    type="text"
                    placeholder="https://<nombre>.cognitiveservices.azure.com/"
                    autocomplete="off"
                  />
                </div>
                <div class="llm-field">
                  <div class="llm-field__heading">
                    <div class="llm-field__text">
                      <label for="ocrAzureKey">
                        AZURE_FORM_RECOGNIZER_KEY
                        <span>Clave del recurso que se usará para el OCR.</span>
                      </label>
                    </div>
                  </div>
                  <input
                    id="ocrAzureKey"
                    type="password"
                    placeholder="Azure key"
                    autocomplete="off"
                  />
                </div>
              </div>
            </div>
            <div class="segmented-control" role="tablist">
              <button
                type="button"
                id="multiModeButton"
                class="active"
                role="tab"
                aria-selected="true"
              >
                Subir archivo
              </button>
              <button
                type="button"
                id="textModeButton"
                role="tab"
                aria-selected="false"
              >
                Ingreso manual
              </button>
            </div>

            <div id="multiMode" role="tabpanel" aria-labelledby="multiModeButton">
              <div class="drop-zone" id="multiDropZone" tabindex="0">
                <div class="drop-zone__icon">📁</div>
                <strong>Selecciona las facturas a procesar</strong>
                <p>Las facturas deben ser del mismo formato.</p>
                <button type="button" id="multiBrowseButton">Buscar archivos</button>
                <input
                  type="file"
                  id="multiFileInput"
                  accept=".pdf,.xml,.json,.png,.jpg,.jpeg,.tif,.tiff"
                  multiple
                  hidden
                />
              </div>

              <div class="multi-details" id="multiDetails" hidden>
                <div class="multi-summary">
                  <span>Tipo detectado:</span>
                  <strong id="multiTypeLabel">—</strong>
                </div>
                <div class="toggle" id="multiPdfToggleRow" hidden>
                  <input type="checkbox" id="multiPdfOcrToggle" />
                  <label for="multiPdfOcrToggle">OCR</label>
                </div>
                <ul class="multi-file-list" id="multiFileList"></ul>
                <div class="progress-row" id="multiProgress" hidden aria-live="polite">
                  <div class="progress-row__meta">
                    <span id="multiProgressText">0 de 0 facturas</span>
                    <strong id="multiProgressPercent">0%</strong>
                  </div>
                  <div
                    class="progress-track"
                    id="multiProgressTrack"
                    role="progressbar"
                    aria-valuemin="0"
                    aria-valuemax="1"
                    aria-valuenow="0"
                  >
                    <div class="progress-bar" id="multiProgressBar"></div>
                  </div>
                </div>
              </div>

              <p class="helper-text" id="multiEmptyState" hidden></p>
            </div>

            <div id="textMode" role="tabpanel" aria-labelledby="textModeButton" hidden>
              <textarea
                id="plainText"
                placeholder="Manualmente coloca el contenido de la factura..."
                aria-label="Contenido manual de la factura"
              ></textarea>
            </div>

            <div class="submit-row">
              <button id="submitButton" class="primary">Procesar</button>
              <button id="clearButton" class="secondary" type="button">Limpiar</button>
              <span id="statusMessage" class="status" role="status"></span>
            </div>
          </div>
        </section>

        <section class="panel" aria-labelledby="outputHeading">
          <div class="results-header">
            <div>
              <h2 id="outputHeading">Resultados</h2>
              <p id="resultsSummary">Procesa un documento para ver los campos extraídos.</p>
            </div>
            <div class="download-group">
              <button id="viewContentButton" type="button" disabled>
                Ver contenido
              </button>
              <button id="downloadJson" disabled>Descargar JSON</button>
              <button id="downloadCsv" disabled>Descargar CSV</button>
            </div>
          </div>

          <div class="results-navigation" id="resultsNavigation" hidden>
            <button type="button" id="prevResult">Anterior</button>
            <span id="resultPosition" class="pill"></span>
            <button type="button" id="nextResult">Siguiente</button>
          </div>

          <div class="result-meta" id="resultMeta" hidden></div>

          <div class="results-grid empty" id="resultsContainer">
            Aún no hay resultados. Procesa un documento para comenzar.
          </div>
        </section>

        <section
          class="panel panel--preview"
          aria-labelledby="previewHeading"
          id="previewPanel"
          hidden
          aria-hidden="true"
        >
          <div class="panel-header">
            <div class="panel-header__text">
              <h2 id="previewHeading">Vista previa</h2>
              <p class="helper-text">Consulta el contenido original del documento seleccionado.</p>
            </div>
          </div>
          <div class="panel-body panel-body--preview">
            <p class="preview-hint" id="dockedPreviewHint" hidden></p>
            <div class="preview-content" id="dockedPreviewContent">
              <p class="preview-placeholder">
                Selecciona “Ver contenido” para mostrarlo aquí.
              </p>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div id="previewModal" class="preview-modal" hidden aria-hidden="true">
      <div
        class="preview-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="previewModalTitle"
      >
        <div class="preview-modal__header">
          <h3 id="previewModalTitle">Vista previa</h3>
          <button
            type="button"
            class="preview-modal__close"
            id="previewModalClose"
            aria-label="Cerrar vista previa"
          >
            &times;
          </button>
        </div>
        <div class="preview-modal__body" id="previewModalContent"></div>
      </div>
    </div>

    <div id="settingsBackdrop" class="settings-backdrop" hidden></div>
    <aside
      id="settingsPanel"
      class="settings-panel"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-labelledby="settingsTitle"
      tabindex="-1"
    >
      <div class="settings-panel__header">
        <h3 id="settingsTitle">Ajustes</h3>
        <button type="button" id="closeSettingsButton" class="settings-close" aria-label="Cerrar ajustes">
          &times;
        </button>
      </div>
      <div class="settings-panel__body">
        <div class="settings-group">
          <div class="settings-option">
            <label for="autoClearToggle">
              Limpiar automáticamente
              <span>Vacía el formulario después de procesar.</span>
            </label>
            <input type="checkbox" id="autoClearToggle" />
          </div>
          <div class="settings-option">
            <label for="themeSelect">
              Apariencia
              <span>Selecciona modo claro u oscuro.</span>
            </label>
            <select id="themeSelect">
              <option value="light">Modo claro</option>
              <option value="dark">Modo oscuro</option>
            </select>
          </div>
          <div class="settings-option">
            <label for="developerToggle">
              Modo desarrollador
              <span>Muestra indicadores adicionales.</span>
            </label>
            <input type="checkbox" id="developerToggle" />
          </div>
        </div>
      </div>
    </aside>

    <script id="llmDefaultsData" type="application/json">
      {{ llm_defaults | tojson }}
    </script>
    <script>
      const SUPPORTED_TYPES = {
        pdf: {
          label: "PDF",
          extensions: ["pdf"],
          endpoint: "file",
        },
        xml: {
          label: "XML",
          extensions: ["xml"],
          endpoint: "file",
        },
        json: {
          label: "JSON",
          extensions: ["json"],
          endpoint: "file",
        },
        image: {
          label: "Imagen",
          extensions: ["png", "jpg", "jpeg", "tif", "tiff"],
          endpoint: "image",
        },
      };

      const REASONING_EFFORT_VALUES = new Set([
        "minimal",
        "low",
        "medium",
        "high",
        "none",
      ]);

      const llmDefaultsElement = document.getElementById("llmDefaultsData");
      let llmDefaults = {
        api: { model: "gpt-5-mini", options: ["gpt-5-mini"] },
        local: { model: "gpt-oss-20b", options: ["gpt-oss-20b"] },
      };
      if (llmDefaultsElement && llmDefaultsElement.textContent) {
        try {
          const parsed = JSON.parse(llmDefaultsElement.textContent);
          if (parsed && typeof parsed === "object") {
            llmDefaults = {
              api: {
                model: parsed.api?.model || llmDefaults.api.model,
                options: Array.isArray(parsed.api?.options)
                  ? parsed.api.options.filter(Boolean)
                  : llmDefaults.api.options,
              },
              local: {
                model: parsed.local?.model || llmDefaults.local.model,
                options: Array.isArray(parsed.local?.options)
                  ? parsed.local.options.filter(Boolean)
                  : llmDefaults.local.options,
              },
            };
          }
        } catch (error) {
          console.warn("No se pudieron cargar los valores por defecto del LLM.", error);
        }
      }

      const ACCEPT_STRING = Object.values(SUPPORTED_TYPES)
        .map((type) => type.extensions.map((ext) => `.${ext}`).join(","))
        .join(",");

      const state = {
        mode: "multi",
        modalPreviewUrl: null,
        multiFiles: [],
        multiCategory: null,
        multiUseOcr: false,
        results: [],
        currentIndex: -1,
        currentHighlights: [],
        llmProvider: "api",
        llmParameters: {
          api: {
            model: llmDefaults.api.model,
            temperature: 1,
            temperature_enabled: false,
            top_p: 1,
            top_p_enabled: false,
            reasoning_effort: "minimal",
            reasoning_effort_enabled: true,
            frequency_penalty: 0,
            frequency_penalty_enabled: false,
            presence_penalty: 0,
            presence_penalty_enabled: false,
            api_key: "",
          },
          local: {
            model: llmDefaults.local.model,
            temperature: 1,
            temperature_enabled: false,
            top_p: 1,
            top_p_enabled: false,
            reasoning_effort: "minimal",
            reasoning_effort_enabled: true,
            frequency_penalty: 0,
            frequency_penalty_enabled: false,
            presence_penalty: 0,
            presence_penalty_enabled: false,
          },
        },
        ocrProvider: "azure-vision",
        ocrParameters: {
          "azure-vision": {
            endpoint: "",
            key: "",
          },
        },
        settings: {
          autoClear: true,
          theme: "light",
          developerMode: false,
        },
      };

      const previewModal = document.getElementById("previewModal");
      const previewModalContent = document.getElementById("previewModalContent");
      const previewModalClose = document.getElementById("previewModalClose");
      const previewPanel = document.getElementById("previewPanel");
      const dockedPreviewContent = document.getElementById("dockedPreviewContent");
      const dockedPreviewHint = document.getElementById("dockedPreviewHint");
      const submitButton = document.getElementById("submitButton");
      const clearButton = document.getElementById("clearButton");
      const statusMessage = document.getElementById("statusMessage");
      const plainText = document.getElementById("plainText");
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsSummary = document.getElementById("resultsSummary");
      const resultsNavigation = document.getElementById("resultsNavigation");
      const resultPosition = document.getElementById("resultPosition");
      const resultMeta = document.getElementById("resultMeta");
      const viewContentButton = document.getElementById("viewContentButton");
      const downloadJson = document.getElementById("downloadJson");
      const downloadCsv = document.getElementById("downloadCsv");
      const prevResultBtn = document.getElementById("prevResult");
      const nextResultBtn = document.getElementById("nextResult");
      const textMode = document.getElementById("textMode");
      const multiMode = document.getElementById("multiMode");
      const textModeButton = document.getElementById("textModeButton");
      const multiModeButton = document.getElementById("multiModeButton");
      const multiDropZone = document.getElementById("multiDropZone");
      const multiBrowseButton = document.getElementById("multiBrowseButton");
      const multiFileInput = document.getElementById("multiFileInput");
      const multiDetails = document.getElementById("multiDetails");
      const multiFileList = document.getElementById("multiFileList");
      const multiTypeLabel = document.getElementById("multiTypeLabel");
      const multiEmptyState = document.getElementById("multiEmptyState");
      const multiPdfToggleRow = document.getElementById("multiPdfToggleRow");
      const multiPdfOcrToggle = document.getElementById("multiPdfOcrToggle");
      const workspace = document.querySelector(".workspace");
      const inputPanel = document.getElementById("inputPanel");
      const inputPanelBody = document.getElementById("inputPanelBody");
      const hideInputPanelButton = document.getElementById("hideInputPanelButton");
      const showInputPanelButton = document.getElementById("showInputPanelButton");
      const multiProgress = document.getElementById("multiProgress");
      const multiProgressText = document.getElementById("multiProgressText");
      const multiProgressPercent = document.getElementById("multiProgressPercent");
      const multiProgressTrack = document.getElementById("multiProgressTrack");
      const multiProgressBar = document.getElementById("multiProgressBar");
      const settingsButton = document.getElementById("settingsButton");
      const settingsPanel = document.getElementById("settingsPanel");
      const settingsBackdrop = document.getElementById("settingsBackdrop");
      const closeSettingsButton = document.getElementById("closeSettingsButton");
      const autoClearToggle = document.getElementById("autoClearToggle");
      const themeSelect = document.getElementById("themeSelect");
      const developerToggle = document.getElementById("developerToggle");
      const developerBadge = document.getElementById("developerBadge");
      const llmProviderRow = document.getElementById("llmProviderRow");
      const llmProviderSelect = document.getElementById("llmProviderSelect");
      const llmSettingsContainer = document.getElementById("llmSettings");
      const llmSettingsSections = document.querySelectorAll(
        "[data-llm-provider-settings]"
      );
      const ocrSettingsContainer = document.getElementById("ocrSettings");
      const ocrProviderSelect = document.getElementById("ocrProviderSelect");
      const ocrSettingsSections = document.querySelectorAll("[data-ocr-provider]");
      const ocrInputs = {
        "azure-vision": {
          endpoint: document.getElementById("ocrAzureEndpoint"),
          key: document.getElementById("ocrAzureKey"),
        },
      };
      const llmModelInputs = {
        api: document.getElementById("llmApiModel"),
        local: document.getElementById("llmLocalModel"),
      };
      const llmTemperatureInputs = {
        api: document.getElementById("llmApiTemperature"),
        local: document.getElementById("llmLocalTemperature"),
      };
      const llmTopPInputs = {
        api: document.getElementById("llmApiTopP"),
        local: document.getElementById("llmLocalTopP"),
      };
      const llmTemperatureToggles = {
        api: document.getElementById("llmApiTemperatureEnabled"),
        local: document.getElementById("llmLocalTemperatureEnabled"),
      };
      const llmTopPToggles = {
        api: document.getElementById("llmApiTopPEnabled"),
        local: document.getElementById("llmLocalTopPEnabled"),
      };
      const llmReasoningToggles = {
        api: document.getElementById("llmApiReasoningEnabled"),
        local: document.getElementById("llmLocalReasoningEnabled"),
      };
      const llmReasoningInputs = {
        api: document.getElementById("llmApiReasoningEffort"),
        local: document.getElementById("llmLocalReasoningEffort"),
      };
      const llmFrequencyInputs = {
        api: document.getElementById("llmApiFrequencyPenalty"),
        local: document.getElementById("llmLocalFrequencyPenalty"),
      };
      const llmPresenceInputs = {
        api: document.getElementById("llmApiPresencePenalty"),
        local: document.getElementById("llmLocalPresencePenalty"),
      };
      const llmFrequencyToggles = {
        api: document.getElementById("llmApiFrequencyEnabled"),
        local: document.getElementById("llmLocalFrequencyEnabled"),
      };
      const llmPresenceToggles = {
        api: document.getElementById("llmApiPresenceEnabled"),
        local: document.getElementById("llmLocalPresenceEnabled"),
      };
      const llmApiKeyInput = document.getElementById("llmApiKey");
      const developerOnlyElements = document.querySelectorAll("[data-developer-only]");

      let lastFocusedElement = null;
      let lastSettingsTrigger = null;
      let isPreviewDocked = false;

      function setMultiPdfToggleVisibility(visible) {
        multiPdfToggleRow.hidden = !visible;
        multiPdfToggleRow.setAttribute("aria-hidden", String(!visible));
        multiPdfToggleRow.style.display = visible ? "flex" : "none";
        if (!visible) {
          state.multiUseOcr = false;
          multiPdfOcrToggle.checked = false;
        }
      }

      function applyTheme(theme) {
        document.body.classList.toggle("theme-dark", theme === "dark");
      }

      function getActiveLlmSettings() {
        const params = ensureLlmParameters(state.llmProvider);
        if (state.settings.developerMode) {
          return params;
        }
        const sanitized = {
          ...params,
          temperature_enabled: false,
          top_p_enabled: false,
          reasoning_effort_enabled: false,
          frequency_penalty_enabled: false,
          presence_penalty_enabled: false,
        };
        if (state.llmProvider === "api") {
          sanitized.api_key = "";
        }
        return sanitized;
      }

      function getActiveOcrSettings() {
        if (!state.ocrProvider) {
          return { provider: "", endpoint: "", key: "" };
        }
        const params = ensureOcrParameters(state.ocrProvider);
        if (!state.settings.developerMode) {
          return { provider: state.ocrProvider, endpoint: "", key: "" };
        }
        return {
          provider: state.ocrProvider,
          endpoint: (params.endpoint || "").trim(),
          key: (params.key || "").trim(),
        };
      }

      function parseNumeric(value) {
        if (value === null || value === undefined) {
          return null;
        }
        const parsed = Number.parseFloat(String(value));
        return Number.isNaN(parsed) ? null : parsed;
      }

      function ensureLlmParameters(provider) {
        if (!provider) {
          return state.llmParameters[state.llmProvider] || {};
        }
        if (!state.llmParameters[provider]) {
          state.llmParameters[provider] =
            provider === "api"
              ? {
                  model: "",
                  temperature: 1,
                  temperature_enabled: false,
                  top_p: 1,
                  top_p_enabled: false,
                  reasoning_effort: "minimal",
                  reasoning_effort_enabled: true,
                  frequency_penalty: 0,
                  frequency_penalty_enabled: false,
                  presence_penalty: 0,
                  presence_penalty_enabled: false,
                  api_key: "",
                }
              : {
                  model: "",
                  temperature: 1,
                  temperature_enabled: false,
                  top_p: 1,
                  top_p_enabled: false,
                  reasoning_effort: "minimal",
                  reasoning_effort_enabled: true,
                  frequency_penalty: 0,
                  frequency_penalty_enabled: false,
                  presence_penalty: 0,
                  presence_penalty_enabled: false,
                };
        }
        const params = state.llmParameters[provider];
        if (!Number.isFinite(params.temperature)) {
          params.temperature = 1;
        }
        if (typeof params.temperature_enabled !== "boolean") {
          params.temperature_enabled = false;
        }
        if (!Number.isFinite(params.top_p)) {
          params.top_p = 1;
        }
        if (typeof params.top_p_enabled !== "boolean") {
          params.top_p_enabled = false;
        }
        if (typeof params.reasoning_effort !== "string") {
          params.reasoning_effort = "minimal";
        }
        if (typeof params.reasoning_effort_enabled !== "boolean") {
          params.reasoning_effort_enabled = true;
        }
        if (!Number.isFinite(params.frequency_penalty)) {
          params.frequency_penalty = 0;
        }
        if (typeof params.frequency_penalty_enabled !== "boolean") {
          params.frequency_penalty_enabled = false;
        }
        if (!Number.isFinite(params.presence_penalty)) {
          params.presence_penalty = 0;
        }
        if (typeof params.presence_penalty_enabled !== "boolean") {
          params.presence_penalty_enabled = false;
        }
        if (provider === "api" && typeof params.api_key !== "string") {
          params.api_key = "";
        }
        return params;
      }

      function ensureOcrParameters(provider) {
        if (!provider) {
          return { endpoint: "", key: "" };
        }
        if (!state.ocrParameters[provider]) {
          state.ocrParameters[provider] = { endpoint: "", key: "" };
        }
        const params = state.ocrParameters[provider];
        if (typeof params.endpoint !== "string") {
          params.endpoint = "";
        }
        if (typeof params.key !== "string") {
          params.key = "";
        }
        return params;
      }

      function setNumericFieldState(input, toggle, enabled) {
        if (toggle) {
          toggle.checked = !!enabled;
        }
        if (input) {
          input.disabled = !enabled;
          const field = input.closest(".llm-field");
          if (field) {
            field.classList.toggle("is-disabled", !enabled);
          }
        } else if (toggle) {
          const field = toggle.closest(".llm-field");
          if (field) {
            field.classList.toggle("is-disabled", !enabled);
          }
        }
      }

      function refreshLlmSettings(provider) {
        if (!llmSettingsContainer) {
          return;
        }
        const targetProvider = provider || state.llmProvider;
        llmSettingsSections.forEach((section) => {
          const sectionProvider = section.getAttribute(
            "data-llm-provider-settings"
          );
          const isActive = sectionProvider === targetProvider;
          section.hidden = !isActive;
          section.setAttribute("aria-hidden", String(!isActive));
        });
        const params = ensureLlmParameters(targetProvider);
        const modelInput = llmModelInputs[targetProvider];
        if (modelInput && modelInput.value !== params.model) {
          modelInput.value = params.model ?? "";
        }
        const temperatureInput = llmTemperatureInputs[targetProvider];
        const temperatureToggle = llmTemperatureToggles[targetProvider];
        if (temperatureInput) {
          const value = Number.isFinite(params.temperature)
            ? params.temperature
            : 1;
          temperatureInput.value = String(value);
        }
        setNumericFieldState(
          temperatureInput,
          temperatureToggle,
          params.temperature_enabled === true
        );
        const topPInput = llmTopPInputs[targetProvider];
        const topPToggle = llmTopPToggles[targetProvider];
        if (topPInput) {
          const value = Number.isFinite(params.top_p) ? params.top_p : 1;
          topPInput.value = String(value);
        }
        setNumericFieldState(
          topPInput,
          topPToggle,
          params.top_p_enabled === true
        );
        const reasoningInput = llmReasoningInputs[targetProvider];
        const reasoningToggle = llmReasoningToggles[targetProvider];
        if (reasoningInput) {
          const value = params.reasoning_effort ?? "minimal";
          reasoningInput.value = value;
        }
        setNumericFieldState(
          reasoningInput,
          reasoningToggle,
          params.reasoning_effort_enabled === true
        );
        const frequencyInput = llmFrequencyInputs[targetProvider];
        const frequencyToggle = llmFrequencyToggles[targetProvider];
        if (frequencyInput) {
          const value = Number.isFinite(params.frequency_penalty)
            ? params.frequency_penalty
            : 0;
          frequencyInput.value = String(value);
        }
        setNumericFieldState(
          frequencyInput,
          frequencyToggle,
          params.frequency_penalty_enabled === true
        );
        const presenceInput = llmPresenceInputs[targetProvider];
        const presenceToggle = llmPresenceToggles[targetProvider];
        if (presenceInput) {
          const value = Number.isFinite(params.presence_penalty)
            ? params.presence_penalty
            : 0;
          presenceInput.value = String(value);
        }
        setNumericFieldState(
          presenceInput,
          presenceToggle,
          params.presence_penalty_enabled === true
        );
        if (targetProvider === "api" && llmApiKeyInput) {
          llmApiKeyInput.value = params.api_key ?? "";
        }
      }

      function refreshOcrSettings(provider) {
        if (!ocrSettingsContainer) {
          return;
        }
        const targetProvider = provider ?? state.ocrProvider;
        if (
          ocrProviderSelect &&
          ocrProviderSelect.value !== (targetProvider || "")
        ) {
          ocrProviderSelect.value = targetProvider || "";
        }
        ocrSettingsSections.forEach((section) => {
          const sectionProvider = section.getAttribute("data-ocr-provider");
          const isActive = sectionProvider === targetProvider && !!sectionProvider;
          section.hidden = !isActive;
          section.setAttribute("aria-hidden", String(!isActive));
          if (!isActive || !sectionProvider) {
            return;
          }
          const params = ensureOcrParameters(sectionProvider);
          const inputs = ocrInputs[sectionProvider] || {};
          if (inputs.endpoint) {
            const nextValue = params.endpoint || "";
            if (inputs.endpoint.value !== nextValue) {
              inputs.endpoint.value = nextValue;
            }
          }
          if (inputs.key) {
            const nextValue = params.key || "";
            if (inputs.key.value !== nextValue) {
              inputs.key.value = nextValue;
            }
          }
        });
      }

      function bindLlmInputs() {
        Object.keys(state.llmParameters).forEach((provider) =>
          ensureLlmParameters(provider)
        );
        Object.entries(llmModelInputs).forEach(([provider, input]) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            params.model = input.value.trim();
          });
        });

        Object.entries(llmTemperatureInputs).forEach(([provider, input]) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            const min = parseNumeric(input.min);
            const max = parseNumeric(input.max);
            let value = parseNumeric(input.value);
            if (value === null) {
              value = params.temperature ?? 1;
            } else {
              if (min !== null) {
                value = Math.max(min, value);
              }
              if (max !== null) {
                value = Math.min(max, value);
              }
            }
            params.temperature = value;
            input.value = String(value);
          });
        });

        Object.entries(llmTopPInputs).forEach(([provider, input]) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            const min = parseNumeric(input.min);
            const max = parseNumeric(input.max);
            let value = parseNumeric(input.value);
            if (value === null) {
              value = params.top_p ?? 1;
            } else {
              if (min !== null) {
                value = Math.max(min, value);
              }
              if (max !== null) {
                value = Math.min(max, value);
              }
            }
            params.top_p = value;
            input.value = String(value);
          });
        });

        Object.entries(llmReasoningInputs).forEach(([provider, input]) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            const value = String(input.value || "").toLowerCase();
            const normalized = REASONING_EFFORT_VALUES.has(value)
              ? value
              : "minimal";
            if (!REASONING_EFFORT_VALUES.has(value)) {
              input.value = "minimal";
            }
            params.reasoning_effort = normalized;
          });
        });

        Object.entries(llmFrequencyInputs).forEach(([provider, input]) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            const min = parseNumeric(input.min);
            const max = parseNumeric(input.max);
            let value = parseNumeric(input.value);
            if (value === null) {
              value = params.frequency_penalty ?? 0;
            } else {
              if (min !== null) {
                value = Math.max(min, value);
              }
              if (max !== null) {
                value = Math.min(max, value);
              }
            }
            params.frequency_penalty = value;
            input.value = String(value);
          });
        });

        Object.entries(llmPresenceInputs).forEach(([provider, input]) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            const min = parseNumeric(input.min);
            const max = parseNumeric(input.max);
            let value = parseNumeric(input.value);
            if (value === null) {
              value = params.presence_penalty ?? 0;
            } else {
              if (min !== null) {
                value = Math.max(min, value);
              }
              if (max !== null) {
                value = Math.min(max, value);
              }
            }
            params.presence_penalty = value;
            input.value = String(value);
          });
        });

        Object.entries(llmTemperatureToggles).forEach(([provider, toggle]) => {
          if (!toggle) {
            return;
          }
          const input = llmTemperatureInputs[provider];
          toggle.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            params.temperature_enabled = toggle.checked;
            setNumericFieldState(input, toggle, params.temperature_enabled);
          });
        });

        Object.entries(llmTopPToggles).forEach(([provider, toggle]) => {
          if (!toggle) {
            return;
          }
          const input = llmTopPInputs[provider];
          toggle.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            params.top_p_enabled = toggle.checked;
            setNumericFieldState(input, toggle, params.top_p_enabled);
          });
        });

        Object.entries(llmReasoningToggles).forEach(([provider, toggle]) => {
          if (!toggle) {
            return;
          }
          const input = llmReasoningInputs[provider];
          toggle.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            params.reasoning_effort_enabled = toggle.checked;
            setNumericFieldState(
              input,
              toggle,
              params.reasoning_effort_enabled
            );
          });
        });

        Object.entries(llmFrequencyToggles).forEach(([provider, toggle]) => {
          if (!toggle) {
            return;
          }
          const input = llmFrequencyInputs[provider];
          toggle.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            params.frequency_penalty_enabled = toggle.checked;
            setNumericFieldState(input, toggle, params.frequency_penalty_enabled);
          });
        });

        Object.entries(llmPresenceToggles).forEach(([provider, toggle]) => {
          if (!toggle) {
            return;
          }
          const input = llmPresenceInputs[provider];
          toggle.addEventListener("change", () => {
            const params = ensureLlmParameters(provider);
            params.presence_penalty_enabled = toggle.checked;
            setNumericFieldState(input, toggle, params.presence_penalty_enabled);
          });
        });

        if (llmApiKeyInput) {
          llmApiKeyInput.addEventListener("input", () => {
            const params = ensureLlmParameters("api");
            params.api_key = llmApiKeyInput.value.trim();
          });
        }
      }

      function bindOcrInputs() {
        if (ocrProviderSelect) {
          ocrProviderSelect.addEventListener("change", (event) => {
            state.ocrProvider = event.target.value;
            refreshOcrSettings(state.ocrProvider);
          });
        }
        Object.entries(ocrInputs).forEach(([provider, inputs]) => {
          if (!inputs) {
            return;
          }
          ensureOcrParameters(provider);
          if (inputs.endpoint) {
            inputs.endpoint.addEventListener("input", () => {
              const params = ensureOcrParameters(provider);
              params.endpoint = inputs.endpoint.value.trim();
            });
          }
          if (inputs.key) {
            inputs.key.addEventListener("input", () => {
              const params = ensureOcrParameters(provider);
              params.key = inputs.key.value.trim();
            });
          }
        });
      }

      function applyDeveloperMode(enabled) {
        document.body.classList.toggle("developer-mode", enabled);
        developerBadge.hidden = !enabled;
        if (llmProviderRow) {
          llmProviderRow.hidden = !enabled;
          llmProviderRow.setAttribute("aria-hidden", String(!enabled));
          if (enabled) {
            if (llmProviderSelect) {
              llmProviderSelect.value = state.llmProvider;
            }
          } else {
            state.llmProvider = "api";
            if (llmProviderSelect) {
              llmProviderSelect.value = "api";
            }
          }
        }
        developerOnlyElements.forEach((element) => {
          if (!element) {
            return;
          }
          element.hidden = !enabled;
          element.setAttribute("aria-hidden", String(!enabled));
        });
        if (llmSettingsContainer) {
          llmSettingsContainer.hidden = !enabled;
          llmSettingsContainer.setAttribute("aria-hidden", String(!enabled));
          if (enabled) {
            refreshLlmSettings(state.llmProvider);
          }
        }
        if (ocrSettingsContainer) {
          ocrSettingsContainer.hidden = !enabled;
          ocrSettingsContainer.setAttribute("aria-hidden", String(!enabled));
          if (enabled) {
            refreshOcrSettings(state.ocrProvider);
          }
        }
      }

      function syncSettingsControls() {
        autoClearToggle.checked = state.settings.autoClear;
        themeSelect.value = state.settings.theme;
        developerToggle.checked = state.settings.developerMode;
      }

      function openSettingsPanel() {
        if (settingsPanel.getAttribute("aria-hidden") === "false") {
          return;
        }
        syncSettingsControls();
        lastSettingsTrigger = document.activeElement;
        settingsPanel.setAttribute("aria-hidden", "false");
        settingsBackdrop.hidden = false;
        settingsButton.setAttribute("aria-expanded", "true");
        settingsPanel.focus({ preventScroll: true });
      }

      function closeSettingsPanel() {
        if (settingsPanel.getAttribute("aria-hidden") === "true") {
          return;
        }
        settingsPanel.setAttribute("aria-hidden", "true");
        settingsBackdrop.hidden = true;
        settingsButton.setAttribute("aria-expanded", "false");
        if (lastSettingsTrigger && typeof lastSettingsTrigger.focus === "function") {
          lastSettingsTrigger.focus({ preventScroll: true });
        }
        lastSettingsTrigger = null;
      }

      function setShowPanelButtonVisibility(visible) {
        showInputPanelButton.toggleAttribute("hidden", !visible);
        showInputPanelButton.setAttribute("aria-hidden", String(!visible));
      }

      function setDockedPreviewMessage(message) {
        if (!dockedPreviewContent) {
          return;
        }
        const placeholder = document.createElement("p");
        placeholder.className = "preview-placeholder";
        placeholder.textContent = message;
        dockedPreviewContent.replaceChildren(placeholder);
        if (dockedPreviewHint) {
          dockedPreviewHint.hidden = true;
          dockedPreviewHint.textContent = "";
        }
      }

      function resetDockedPreview() {
        setDockedPreviewMessage("Selecciona “Ver contenido” para mostrarlo aquí.");
      }

      function setPreviewDocked(enabled) {
        isPreviewDocked = enabled;
        workspace.classList.toggle("workspace--with-preview", enabled);
        if (!previewPanel) {
          return;
        }
        if (enabled) {
          previewPanel.hidden = false;
          previewPanel.setAttribute("aria-hidden", "false");
          resetDockedPreview();
          if (state.results.length > 0) {
            const safeIndex = Math.max(
              0,
              Math.min(state.currentIndex, state.results.length - 1)
            );
            const entry = state.results[safeIndex];
            if (entry) {
              state.currentHighlights = getEntryHighlights(entry);
              if (typeof entry.previewText === "string" && entry.previewText.trim()) {
                showPlainTextPreview(entry.previewText, entry.textOrigin || "");
              } else {
                setDockedPreviewMessage("No hay contenido disponible.");
              }
            }
          }
        } else {
          previewPanel.hidden = true;
          previewPanel.setAttribute("aria-hidden", "true");
          resetDockedPreview();
        }
      }

      function collapseInputPanel() {
        if (workspace.classList.contains("workspace--input-hidden")) {
          return;
        }
        workspace.classList.add("workspace--input-hidden");
        inputPanel.setAttribute("aria-hidden", "true");
        inputPanelBody.setAttribute("aria-hidden", "true");
        setShowPanelButtonVisibility(true);
        setPreviewDocked(true);
        hideInputPanelButton.setAttribute("aria-pressed", "true");
        showInputPanelButton.focus({ preventScroll: true });
      }

      function expandInputPanel() {
        if (!workspace.classList.contains("workspace--input-hidden")) {
          return;
        }
        workspace.classList.remove("workspace--input-hidden");
        inputPanel.removeAttribute("aria-hidden");
        inputPanelBody.removeAttribute("aria-hidden");
        setShowPanelButtonVisibility(false);
        setPreviewDocked(false);
        hideInputPanelButton.setAttribute("aria-pressed", "false");
        hideInputPanelButton.focus({ preventScroll: true });
      }

      function resetMultiProgress() {
        multiProgress.hidden = true;
        multiProgressTrack.setAttribute("aria-valuenow", "0");
        multiProgressTrack.setAttribute("aria-valuemax", "1");
        multiProgressBar.style.width = "0%";
        multiProgressText.textContent = "0 de 0 facturas";
        multiProgressPercent.textContent = "0%";
      }

      function showMultiProgress(total) {
        multiProgress.hidden = false;
        multiProgressTrack.setAttribute("aria-valuemin", "0");
        multiProgressTrack.setAttribute("aria-valuemax", String(total));
        multiProgressTrack.setAttribute("aria-valuenow", "0");
        multiProgressBar.style.width = "0%";
        multiProgressText.textContent = `0 de ${total} facturas`;
        multiProgressPercent.textContent = "0%";
      }

      function updateMultiProgress(current, total) {
        multiProgressTrack.setAttribute("aria-valuenow", String(current));
        const percentage = total === 0 ? 0 : Math.round((current / total) * 100);
        multiProgressBar.style.width = `${percentage}%`;
        multiProgressText.textContent = `${current} de ${total} facturas`;
        multiProgressPercent.textContent = `${percentage}%`;
      }

      function closePreviewModal() {
        if (previewModal.hidden) {
          return;
        }
        const focusTarget = lastFocusedElement;
        previewModal.hidden = true;
        previewModal.setAttribute("aria-hidden", "true");
        if (state.modalPreviewUrl) {
          URL.revokeObjectURL(state.modalPreviewUrl);
          state.modalPreviewUrl = null;
        }
        previewModalContent.innerHTML = "";
        document.body.classList.remove("modal-open");
        if (focusTarget && typeof focusTarget.focus === "function") {
          focusTarget.focus();
        }
        lastFocusedElement = null;
      }

      function renderModalPreview(file, category) {
        previewModalContent.innerHTML = "";
        if (!file || !category) {
          const message = document.createElement("p");
          message.style.padding = "1.25rem";
          message.textContent = "No hay vista previa disponible.";
          previewModalContent.appendChild(message);
          return;
        }

        if (category === "image" || category === "pdf") {
          if (state.modalPreviewUrl) {
            URL.revokeObjectURL(state.modalPreviewUrl);
            state.modalPreviewUrl = null;
          }
          const url = URL.createObjectURL(file);
          state.modalPreviewUrl = url;

          if (category === "image") {
            const img = document.createElement("img");
            img.src = url;
            img.alt = "Vista previa ampliada de la imagen subida";
            previewModalContent.appendChild(img);
          } else {
            const iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.title = "Vista previa ampliada del PDF";
            previewModalContent.appendChild(iframe);
          }
        } else {
          if (state.modalPreviewUrl) {
            URL.revokeObjectURL(state.modalPreviewUrl);
            state.modalPreviewUrl = null;
          }
          const placeholder = document.createElement("p");
          placeholder.style.padding = "1.25rem";
          placeholder.textContent = "Cargando vista previa...";
          previewModalContent.appendChild(placeholder);
          const reader = new FileReader();
          reader.onload = () => {
            const text = reader.result || "";
            previewModalContent.innerHTML = "";
            const pre = document.createElement("pre");
            pre.textContent = String(text).slice(0, 20000);
            previewModalContent.appendChild(pre);
          };
          reader.readAsText(file, "utf-8");
        }
      }

      function showModalPreview(file, category) {
        if (!file || !category) {
          return;
        }
        renderModalPreview(file, category);
        openPreviewModal();
      }

      function openPreviewModal() {
        lastFocusedElement = document.activeElement;
        previewModal.hidden = false;
        previewModal.setAttribute("aria-hidden", "false");
        document.body.classList.add("modal-open");
        previewModalClose.focus();
      }

      previewModalClose.addEventListener("click", () => {
        closePreviewModal();
      });

      previewModal.addEventListener("click", (event) => {
        if (event.target === previewModal) {
          closePreviewModal();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") {
          return;
        }
        if (!previewModal.hidden) {
          event.preventDefault();
          closePreviewModal();
          return;
        }
        if (settingsPanel.getAttribute("aria-hidden") === "false") {
          event.preventDefault();
          closeSettingsPanel();
        }
      });

      bindLlmInputs();
      bindOcrInputs();
      refreshLlmSettings(state.llmProvider);
      refreshOcrSettings(state.ocrProvider);

      setMultiPdfToggleVisibility(false);
      resetMultiProgress();

      hideInputPanelButton.addEventListener("click", () => {
        collapseInputPanel();
      });

      showInputPanelButton.addEventListener("click", () => {
        expandInputPanel();
      });

      settingsButton.addEventListener("click", () => {
        openSettingsPanel();
      });

      closeSettingsButton.addEventListener("click", () => {
        closeSettingsPanel();
      });

      settingsBackdrop.addEventListener("click", () => {
        closeSettingsPanel();
      });

      autoClearToggle.addEventListener("change", (event) => {
        state.settings.autoClear = event.target.checked;
      });

      themeSelect.addEventListener("change", (event) => {
        state.settings.theme = event.target.value;
        applyTheme(state.settings.theme);
      });

      developerToggle.addEventListener("change", (event) => {
        state.settings.developerMode = event.target.checked;
        applyDeveloperMode(state.settings.developerMode);
      });

      if (llmProviderSelect) {
        llmProviderSelect.addEventListener("change", (event) => {
          const value = event.target.value === "local" ? "local" : "api";
          state.llmProvider = value;
          refreshLlmSettings(state.llmProvider);
        });
      }

      applyTheme(state.settings.theme);
      applyDeveloperMode(state.settings.developerMode);
      setShowPanelButtonVisibility(false);

      multiFileInput.setAttribute("accept", ACCEPT_STRING);

      function resetMultiFiles() {
        state.multiFiles = [];
        state.multiCategory = null;
        state.multiUseOcr = false;
        multiFileInput.value = "";
        multiDetails.hidden = true;
        multiEmptyState.hidden = true;
        multiFileList.innerHTML = "";
        multiTypeLabel.textContent = "—";
        setMultiPdfToggleVisibility(false);
        resetMultiProgress();
      }

      function setStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.classList.toggle("error", Boolean(isError));
      }

      function setActiveModeButton(button, isActive) {
        button.classList.toggle("active", isActive);
        button.setAttribute("aria-selected", String(isActive));
      }

      function switchMode(mode) {
        if (mode === state.mode) return;
        state.mode = mode;
        const isTextMode = mode === "text";
        const isMultiMode = mode === "multi";
        textMode.hidden = !isTextMode;
        multiMode.hidden = !isMultiMode;
        setActiveModeButton(textModeButton, isTextMode);
        setActiveModeButton(multiModeButton, isMultiMode);
        const inputHidden = workspace.classList.contains("workspace--input-hidden");
        if (isTextMode) {
          resetMultiFiles();
          if (!inputHidden) {
            plainText.focus();
          }
        } else if (!inputHidden) {
          plainText.value = "";
          multiDropZone.focus();
        }
        setStatus("");
      }

      textModeButton.addEventListener("click", () => switchMode("text"));
      multiModeButton.addEventListener("click", () => switchMode("multi"));

      function detectCategory(file) {
        const extension = (file.name.split(".").pop() || "").toLowerCase();
        const mime = (file.type || "").toLowerCase();
        if (mime.startsWith("image/")) {
          return "image";
        }
        for (const [key, info] of Object.entries(SUPPORTED_TYPES)) {
          if (info.extensions.includes(extension)) {
            return key;
          }
        }
        if (mime === "application/pdf") {
          return "pdf";
        }
        return null;
      }

      function renderMultiList() {
        if (!state.multiFiles.length) {
          resetMultiFiles();
          return;
        }
        multiDetails.hidden = false;
        multiEmptyState.hidden = true;
        const label = SUPPORTED_TYPES[state.multiCategory].label;
        const isPdfBatch = state.multiCategory === "pdf" && state.multiFiles.length > 0;
        setMultiPdfToggleVisibility(isPdfBatch);
        if (isPdfBatch) {
          multiPdfOcrToggle.checked = state.multiUseOcr;
          multiTypeLabel.textContent = `${label}${state.multiUseOcr ? " (OCR)" : ""}`;
        } else {
          multiTypeLabel.textContent = label;
        }
        multiFileList.innerHTML = "";
        state.multiFiles.forEach((entry, index) => {
          const item = document.createElement("li");
          item.className = "multi-file-item";
          const info = document.createElement("span");
          const name = document.createElement("strong");
          name.textContent = entry.file.name;
          const type = document.createElement("small");
          type.textContent =
            entry.category === "pdf" && state.multiUseOcr
              ? `${SUPPORTED_TYPES[entry.category].label} (OCR)`
              : SUPPORTED_TYPES[entry.category].label;
          info.appendChild(name);
          info.appendChild(type);
          const actions = document.createElement("div");
          actions.className = "multi-file-actions";

          const viewButton = document.createElement("button");
          viewButton.type = "button";
          viewButton.textContent = "Ver";
          viewButton.className = "preview-action";
          viewButton.setAttribute(
            "aria-label",
            `Ver ${entry.file.name} en pantalla completa`
          );
          viewButton.addEventListener("click", () => {
            showModalPreview(entry.file, entry.category);
          });

          const removeButton = document.createElement("button");
          removeButton.type = "button";
          removeButton.textContent = "×";
          removeButton.className = "remove-button";
          removeButton.setAttribute(
            "aria-label",
            `Eliminar ${entry.file.name} de la lista`
          );
          removeButton.addEventListener("click", () => {
            state.multiFiles.splice(index, 1);
            if (!state.multiFiles.length) {
              state.multiCategory = null;
              state.multiUseOcr = false;
              multiPdfOcrToggle.checked = false;
            }
            renderMultiList();
          });

          actions.appendChild(viewButton);
          actions.appendChild(removeButton);

          item.appendChild(info);
          item.appendChild(actions);
          multiFileList.appendChild(item);
        });
      }

      function handleMultiSelection(file) {
        const category = detectCategory(file);
        if (!category) {
          setStatus(`El archivo ${file.name} no es de un formato admitido.`, true);
          return;
        }
        if (state.multiCategory && state.multiCategory !== category) {
          setStatus(
            "Todos los archivos deben ser del mismo tipo para el procesamiento en lote.",
            true
          );
          return;
        }
        state.multiCategory = category;
        if (category !== "pdf") {
          setMultiPdfToggleVisibility(false);
        }
        const uploadedAt = Date.now();
        state.multiFiles.push({ file, category, uploadedAt });
        renderMultiList();
        setStatus("");
      }

      function handleMultiFileList(fileList) {
        if (!fileList || !fileList.length) {
          return;
        }
        Array.from(fileList).forEach((file) => handleMultiSelection(file));
        multiFileInput.value = "";
      }

      multiBrowseButton.addEventListener("click", () => {
        if (state.mode !== "multi") return;
        multiFileInput.click();
      });

      multiFileInput.addEventListener("change", (event) => {
        const files = event.target.files;
        handleMultiFileList(files);
      });

      multiDropZone.addEventListener("click", () => {
        if (state.mode !== "multi") return;
        multiFileInput.click();
      });

      multiDropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        if (state.mode === "multi") {
          multiDropZone.classList.add("dragging");
        }
      });

      ["dragleave", "dragend", "drop"].forEach((eventName) => {
        multiDropZone.addEventListener(eventName, () =>
          multiDropZone.classList.remove("dragging")
        );
      });

      multiDropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        if (state.mode !== "multi") {
          return;
        }
        const { files } = event.dataTransfer;
        handleMultiFileList(files);
      });

      multiPdfOcrToggle.addEventListener("change", () => {
        state.multiUseOcr = multiPdfOcrToggle.checked;
        renderMultiList();
      });

      function flattenData(data, prefix = "") {
        if (data === null || data === undefined) {
          return { [prefix.slice(0, -1)]: null };
        }
        if (typeof data !== "object") {
          return { [prefix.slice(0, -1)]: data };
        }
        if (Array.isArray(data)) {
          if (!data.length) {
            return { [prefix.slice(0, -1)]: [] };
          }
          const result = {};
          data.forEach((value, index) => {
            Object.entries(flattenData(value, `${prefix}${index}.`)).forEach(
              ([key, val]) => {
                result[key] = val;
              }
            );
          });
          return result;
        }
        const entries = Object.entries(data);
        if (!entries.length) {
          return { [prefix.slice(0, -1)]: {} };
        }
        const result = {};
        entries.forEach(([key, value]) => {
          Object.entries(flattenData(value, `${prefix}${key}.`)).forEach(([child, val]) => {
            result[child] = val;
          });
        });
        return result;
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function escapeAttribute(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function escapeRegExp(value) {
        return String(value).replace(/[\\^$*+?.()|{}\[\]-]/g, "\\$&");
      }

      function computePreviewHighlights(flatData) {
        if (!flatData || typeof flatData !== "object") {
          return [];
        }
        return Object.entries(flatData).reduce((list, [key, value]) => {
          if (value === null || value === undefined) {
            return list;
          }
          const label = key || "(valor)";
          if (typeof value === "string") {
            const trimmed = value.trim();
            if (!trimmed) {
              return list;
            }
            const isNumericLike = /^-?\d+(?:[.,]\d+)?$/.test(trimmed);
            if (trimmed.length < 2 && !isNumericLike) {
              return list;
            }
            list.push({ field: label, value: trimmed });
            return list;
          }
          if (typeof value === "number") {
            const text = String(value);
            if (text) {
              list.push({ field: label, value: text });
            }
            return list;
          }
          if (typeof value === "boolean") {
            list.push({ field: label, value: value ? "true" : "false" });
            return list;
          }
          return list;
        }, []);
      }

      function buildHighlightMatches(text, highlights) {
        if (!text || !Array.isArray(highlights) || highlights.length === 0) {
          return [];
        }
        const matches = [];
        highlights.forEach(({ field, value }) => {
          if (!value) {
            return;
          }
          const pattern = new RegExp(escapeRegExp(value), "gi");
          let match;
          while ((match = pattern.exec(text)) !== null) {
            matches.push({
              start: match.index,
              end: match.index + match[0].length,
              field: field || "(valor)",
            });
            if (match.index === pattern.lastIndex) {
              pattern.lastIndex += 1;
            }
          }
        });
        if (!matches.length) {
          return [];
        }
        matches.sort((a, b) => {
          if (a.start === b.start) {
            return b.end - a.end;
          }
          return a.start - b.start;
        });
        const filtered = [];
        let lastEnd = -1;
        matches.forEach((match) => {
          if (match.start >= lastEnd) {
            filtered.push(match);
            lastEnd = match.end;
          }
        });
        return filtered;
      }

      function applyPreviewHighlights(target, text, highlights) {
        if (!target) {
          return;
        }
        const source = typeof text === "string" ? text : "";
        const matches = buildHighlightMatches(source, highlights);
        if (!matches.length) {
          target.textContent = source;
          return;
        }
        const fragments = [];
        let cursor = 0;
        matches.forEach((match) => {
          if (match.start > cursor) {
            fragments.push(escapeHtml(source.slice(cursor, match.start)));
          }
          const label = match.field || "(valor)";
          const attrLabel = escapeAttribute(label);
          const highlighted = escapeHtml(source.slice(match.start, match.end));
          fragments.push(
            `<span class="preview-highlight" data-field="${attrLabel}" title="${attrLabel}">${highlighted}</span>`
          );
          cursor = match.end;
        });
        if (cursor < source.length) {
          fragments.push(escapeHtml(source.slice(cursor)));
        }
        target.innerHTML = fragments.join("");
      }

      function getEntryHighlights(entry, precomputedFlat) {
        if (!entry) {
          return [];
        }
        if (Array.isArray(entry.previewHighlights)) {
          return entry.previewHighlights;
        }
        const flatData =
          precomputedFlat && typeof precomputedFlat === "object"
            ? precomputedFlat
            : flattenData(entry.data || {});
        const highlights = computePreviewHighlights(flatData);
        entry.previewHighlights = highlights;
        return highlights;
      }

      function normalizeExtractionResponse(payload, fallbackText = "") {
        const response =
          payload && typeof payload === "object" && !Array.isArray(payload) ? payload : {};
        const hasStructuredFields =
          response.fields &&
          typeof response.fields === "object" &&
          !Array.isArray(response.fields) &&
          (Object.prototype.hasOwnProperty.call(response, "raw_text") ||
            Object.prototype.hasOwnProperty.call(response, "text_origin"));
        const fieldsCandidate = hasStructuredFields ? response.fields : response;
        const fallback = typeof fallbackText === "string" ? fallbackText : "";
        const rawText =
          typeof response.raw_text === "string" && response.raw_text.trim()
            ? response.raw_text
            : fallback;
        const normalizedOrigin =
          typeof response.text_origin === "string"
            ? response.text_origin.trim().toLowerCase()
            : "";
        const origin = normalizedOrigin ? normalizedOrigin : rawText ? "input" : "";
        return {
          fields: fieldsCandidate,
          rawText,
          textOrigin: origin,
        };
      }

      function getTextOriginDescription(origin) {
        switch (origin) {
          case "ocr":
            return "Contenido obtenido mediante OCR.";
          case "file":
            return "Texto extraído directamente del archivo.";
          case "input":
            return "Texto proporcionado manualmente.";
          default:
            return "";
        }
      }

      function showPlainTextPreview(text, origin) {
        if (state.modalPreviewUrl) {
          URL.revokeObjectURL(state.modalPreviewUrl);
          state.modalPreviewUrl = null;
        }
        const normalized = typeof text === "string" ? text : "";
        const hint = getTextOriginDescription(origin);
        if (isPreviewDocked && dockedPreviewContent) {
          if (!normalized.trim()) {
            setDockedPreviewMessage("No hay contenido disponible.");
            return;
          }
          if (dockedPreviewHint) {
            if (hint) {
              dockedPreviewHint.hidden = false;
              dockedPreviewHint.textContent = hint;
            } else {
              dockedPreviewHint.hidden = true;
              dockedPreviewHint.textContent = "";
            }
          }
          const pre = document.createElement("pre");
          applyPreviewHighlights(pre, normalized, state.currentHighlights);
          dockedPreviewContent.replaceChildren(pre);
          return;
        }
        previewModalContent.innerHTML = "";
        if (!normalized.trim()) {
          const message = document.createElement("p");
          message.style.padding = "1.25rem";
          message.textContent = "No hay contenido disponible.";
          previewModalContent.appendChild(message);
          openPreviewModal();
          return;
        }
        if (hint) {
          const hintElement = document.createElement("p");
          hintElement.className = "preview-hint";
          hintElement.textContent = hint;
          previewModalContent.appendChild(hintElement);
        }
        const pre = document.createElement("pre");
        applyPreviewHighlights(pre, normalized, state.currentHighlights);
        previewModalContent.appendChild(pre);
        openPreviewModal();
      }

      function renderResult(index) {
        if (isPreviewDocked) {
          resetDockedPreview();
        }
        if (state.results.length === 0) {
          state.currentHighlights = [];
          resultsContainer.classList.add("empty");
          resultsContainer.innerHTML =
            "Aún no hay resultados. Procesa un documento para comenzar.";
          resultsSummary.textContent = "Procesa un documento para ver los campos extraídos.";
          resultsNavigation.hidden = true;
          resultMeta.hidden = true;
          if (viewContentButton) {
            viewContentButton.disabled = true;
            viewContentButton.removeAttribute("title");
            viewContentButton.setAttribute("aria-label", "Ver contenido");
          }
          downloadJson.disabled = true;
          downloadCsv.disabled = true;
          return;
        }

        const entry = state.results[index];
        const uploadedAt = entry.uploadedAt || entry.timestamp;
        resultsContainer.classList.remove("empty");
        resultsContainer.innerHTML = "";
        resultsSummary.textContent = `Última actualización: ${new Date(
          uploadedAt
        ).toLocaleString()}`;

        const flat = flattenData(entry.data);
        const highlights = getEntryHighlights(entry, flat);
        state.currentHighlights = Array.isArray(highlights) ? highlights : [];
        Object.keys(flat)
          .sort((a, b) => a.localeCompare(b))
          .forEach((key) => {
            const value = flat[key];
            const field = document.createElement("div");
            field.className = "result-field";
            const label = document.createElement("label");
            label.textContent = key || "(valor)";
            const valueElement = document.createElement("div");
            valueElement.className = "value";
            if (value === null || value === undefined || value === "" || (Array.isArray(value) && value.length === 0)) {
              valueElement.classList.add("missing");
              valueElement.textContent = "Sin valor";
            } else if (typeof value === "object") {
              valueElement.textContent = JSON.stringify(value);
            } else {
              valueElement.textContent = String(value);
            }
            field.appendChild(label);
            field.appendChild(valueElement);
            resultsContainer.appendChild(field);
          });

        resultMeta.hidden = false;
        const metaParts = [
          `<div><span class="pill">${entry.source}</span></div>`,
          `<div>Subido el <strong>${new Date(uploadedAt).toLocaleString()}</strong></div>`,
          `<div>Procesado el <strong>${new Date(entry.timestamp).toLocaleString()}</strong></div>`,
        ];
        resultMeta.innerHTML = metaParts.join("");

        resultsNavigation.hidden = state.results.length <= 1;
        resultPosition.textContent = `Documento ${index + 1} de ${state.results.length}`;
        resultPosition.setAttribute("aria-live", "polite");
        prevResultBtn.disabled = index === 0;
        nextResultBtn.disabled = index === state.results.length - 1;
        if (viewContentButton) {
          const hasPreview =
            typeof entry.previewText === "string" && entry.previewText.trim().length > 0;
          viewContentButton.disabled = !hasPreview;
          const description = getTextOriginDescription(entry.textOrigin || "");
          if (hasPreview && description) {
            viewContentButton.setAttribute(
              "aria-label",
              `Ver contenido. ${description}`
            );
            viewContentButton.setAttribute("title", description);
          } else {
            viewContentButton.setAttribute("aria-label", "Ver contenido");
            viewContentButton.removeAttribute("title");
          }
        }
        downloadJson.disabled = false;
        downloadCsv.disabled = false;
        if (isPreviewDocked) {
          const hasPreview =
            typeof entry.previewText === "string" && entry.previewText.trim().length > 0;
          if (hasPreview) {
            showPlainTextPreview(entry.previewText, entry.textOrigin || "");
          } else {
            setDockedPreviewMessage("No hay contenido disponible.");
          }
        }
      }

      function addResultEntry(data, source, options = {}) {
        const timestamp = Date.now();
        const entry = {
          id:
            typeof crypto !== "undefined" && typeof crypto.randomUUID === "function"
              ? crypto.randomUUID()
              : Math.random().toString(36).slice(2),
          data,
          source,
          timestamp,
          previewText:
            typeof options.previewText === "string" ? options.previewText : "",
          textOrigin:
            typeof options.textOrigin === "string" ? options.textOrigin : "",
          uploadedAt: options.uploadedAt || timestamp,
        };
        state.results.push(entry);
        state.currentIndex = state.results.length - 1;
        renderResult(state.currentIndex);
      }

      prevResultBtn.addEventListener("click", () => {
        if (state.currentIndex > 0) {
          state.currentIndex -= 1;
          renderResult(state.currentIndex);
        }
      });

      nextResultBtn.addEventListener("click", () => {
        if (state.currentIndex < state.results.length - 1) {
          state.currentIndex += 1;
          renderResult(state.currentIndex);
        }
      });

      function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
      }

      function buildDownloadPayloads() {
        const enriched = state.results.map((entry) => ({
          id: entry.id,
          archivo: entry.source,
          subido_en: new Date((entry.uploadedAt || entry.timestamp)).toISOString(),
          procesado_en: new Date(entry.timestamp).toISOString(),
          datos: entry.data,
        }));
        return enriched;
      }

      downloadJson.addEventListener("click", () => {
        if (!state.results.length) return;
        const payload = buildDownloadPayloads();
        downloadFile(JSON.stringify(payload, null, 2), "resultados_verifactura.json", "application/json");
      });

      downloadCsv.addEventListener("click", () => {
        if (!state.results.length) return;
        const payload = buildDownloadPayloads();
        const allKeys = new Set(["id", "archivo", "subido_en", "procesado_en"]);
        payload.forEach((item) => {
          Object.keys(flattenData(item.datos)).forEach((key) => {
            if (!key) {
              allKeys.add("datos");
            } else {
              allKeys.add(`datos.${key}`);
            }
          });
        });
        const headers = Array.from(allKeys);
        const rows = payload.map((item) => {
          const flat = flattenData(item.datos);
          const values = headers.map((header) => {
            if (header === "id") return item.id;
            if (header === "archivo") return item.archivo;
            if (header === "subido_en") return item.subido_en;
            if (header === "procesado_en") return item.procesado_en;
            const key = header === "datos" ? "" : header.replace(/^datos\./, "");
            const value = Object.prototype.hasOwnProperty.call(flat, key)
              ? flat[key]
              : null;
            if (value === null || value === undefined) {
              return "";
            }
            if (typeof value === "object") {
              return JSON.stringify(value);
            }
            return String(value);
          });
          return values
            .map((value) => {
              const escaped = String(value).replace(/"/g, '""');
              return `"${escaped}"`;
            })
            .join(",");
        });
        const csv = [headers.join(","), ...rows].join("\n");
        downloadFile(csv, "resultados_verifactura.csv", "text/csv;charset=utf-8");
      });

      if (viewContentButton) {
        viewContentButton.addEventListener("click", () => {
          const entry = state.results[state.currentIndex];
          if (!entry || !entry.previewText || !entry.previewText.trim()) {
            return;
          }
          state.currentHighlights = getEntryHighlights(entry);
          showPlainTextPreview(entry.previewText, entry.textOrigin || "");
        });
      }

      function validateBeforeSend() {
        if (state.mode === "text") {
          const value = plainText.value.trim();
          if (!value) {
            throw new Error("Ingresa texto para procesar.");
          }
          return { type: "text", payload: value };
        }
        if (state.mode === "multi") {
          if (!state.multiFiles.length || !state.multiCategory) {
            throw new Error("Agrega al menos un archivo para procesar en lote.");
          }
          return {
            type: "multi",
            payload: {
              category: state.multiCategory,
              entries: state.multiFiles.map((entry) => ({ ...entry })),
              useOcr: state.multiUseOcr,
            },
          };
        }
        throw new Error("Selecciona un modo de procesamiento válido.");
      }

      async function sendText(text) {
        const activeSettings = getActiveLlmSettings();
        const payload = {
          text,
          llm_provider: state.llmProvider,
        };
        if (activeSettings.model) {
          payload.llm_model = activeSettings.model;
        }
        if (
          activeSettings.temperature_enabled === true &&
          Number.isFinite(activeSettings.temperature)
        ) {
          payload.temperature = activeSettings.temperature;
        }
        if (
          activeSettings.top_p_enabled === true &&
          Number.isFinite(activeSettings.top_p)
        ) {
          payload.top_p = activeSettings.top_p;
        }
        if (
          activeSettings.reasoning_effort_enabled === true &&
          typeof activeSettings.reasoning_effort === "string"
        ) {
          const value = activeSettings.reasoning_effort.trim();
          if (value) {
            payload.reasoning_effort = value;
          }
        }
        if (
          activeSettings.frequency_penalty_enabled === true &&
          Number.isFinite(activeSettings.frequency_penalty)
        ) {
          payload.frequency_penalty = activeSettings.frequency_penalty;
        }
        if (
          activeSettings.presence_penalty_enabled === true &&
          Number.isFinite(activeSettings.presence_penalty)
        ) {
          payload.presence_penalty = activeSettings.presence_penalty;
        }
        if (state.llmProvider === "api") {
          const apiKey = (activeSettings.api_key || "").trim();
          if (apiKey) {
            payload.openai_api_key = apiKey;
          }
        }
        const response = await fetch("/api/v1/extract/text", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          throw new Error(detail.detail || "No se pudo procesar el texto.");
        }
        return response.json();
      }

      async function sendFile(file, type, options = {}) {
        const { useOcr = false } = options;
        const formData = new FormData();
        const fieldName = type === "image" ? "image" : "file";
        formData.append(fieldName, file);
        let endpoint = "/api/v1/extract/file";
        if (type === "image") {
          endpoint = "/api/v1/extract/image";
        }
        const url = new URL(endpoint, window.location.origin);
        if (type === "pdf" && useOcr) {
          url.searchParams.set("force_ocr", "true");
        }
        url.searchParams.set("llm_provider", state.llmProvider);
        const activeSettings = getActiveLlmSettings();
        if (activeSettings.model) {
          url.searchParams.set("llm_model", activeSettings.model);
        }
        if (
          activeSettings.temperature_enabled === true &&
          Number.isFinite(activeSettings.temperature)
        ) {
          url.searchParams.set(
            "temperature",
            String(activeSettings.temperature)
          );
        }
        if (
          activeSettings.top_p_enabled === true &&
          Number.isFinite(activeSettings.top_p)
        ) {
          url.searchParams.set("top_p", String(activeSettings.top_p));
        }
        if (
          activeSettings.reasoning_effort_enabled === true &&
          typeof activeSettings.reasoning_effort === "string"
        ) {
          const value = activeSettings.reasoning_effort.trim();
          if (value) {
            url.searchParams.set("reasoning_effort", value);
          }
        }
        if (
          activeSettings.frequency_penalty_enabled === true &&
          Number.isFinite(activeSettings.frequency_penalty)
        ) {
          url.searchParams.set(
            "frequency_penalty",
            String(activeSettings.frequency_penalty)
          );
        }
        if (
          activeSettings.presence_penalty_enabled === true &&
          Number.isFinite(activeSettings.presence_penalty)
        ) {
          url.searchParams.set(
            "presence_penalty",
            String(activeSettings.presence_penalty)
          );
        }
        if (state.llmProvider === "api") {
          const apiKey = (activeSettings.api_key || "").trim();
          if (apiKey) {
            url.searchParams.set("openai_api_key", apiKey);
          }
        }
        const ocrSettings = getActiveOcrSettings();
        if (ocrSettings.provider) {
          url.searchParams.set("ocr_provider", ocrSettings.provider);
          if (ocrSettings.endpoint) {
            url.searchParams.set(
              "azure_form_recognizer_endpoint",
              ocrSettings.endpoint
            );
          }
          if (ocrSettings.key) {
            url.searchParams.set(
              "azure_form_recognizer_key",
              ocrSettings.key
            );
          }
        }
        const response = await fetch(url, {
          method: "POST",
          body: formData,
        });
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          throw new Error(detail.detail || "No se pudo procesar el archivo.");
        }
        return response.json();
      }

      async function handleSubmit() {
        try {
          setStatus("Procesando...", false);
          submitButton.disabled = true;
          const { type, payload } = validateBeforeSend();
          if (type === "text") {
            const now = Date.now();
            const result = await sendText(payload);
            const normalized = normalizeExtractionResponse(result, payload);
            addResultEntry(normalized.fields, "Ingreso manual", {
              uploadedAt: now,
              previewText: normalized.rawText,
              textOrigin: normalized.textOrigin || "input",
            });
            if (state.settings.autoClear) {
              plainText.value = "";
            }
          } else if (type === "multi") {
            const { category, entries, useOcr } = payload;
            showMultiProgress(entries.length);
            updateMultiProgress(0, entries.length);
            for (let index = 0; index < entries.length; index += 1) {
              const currentEntry = entries[index];
              setStatus(
                `Procesando factura ${index + 1} de ${entries.length}...`,
                false
              );
              const currentResult = await sendFile(currentEntry.file, category, {
                useOcr: category === "pdf" ? useOcr : false,
              });
              const label =
                category === "pdf"
                  ? `${SUPPORTED_TYPES[category].label}${useOcr ? " (OCR)" : ""}`
                  : SUPPORTED_TYPES[category].label;
              const description = `${label} · ${currentEntry.file.name}`;
              const normalized = normalizeExtractionResponse(currentResult);
              addResultEntry(normalized.fields, description, {
                uploadedAt: currentEntry.uploadedAt || Date.now(),
                previewText: normalized.rawText,
                textOrigin: normalized.textOrigin,
              });
              updateMultiProgress(index + 1, entries.length);
            }
            if (state.settings.autoClear) {
              resetMultiFiles();
            } else {
              renderMultiList();
            }
          }
          setStatus("¡Extracción completada!", false);
        } catch (error) {
          console.error(error);
          resetMultiProgress();
          setStatus(error.message || "No se pudo completar la solicitud.", true);
        } finally {
          submitButton.disabled = false;
        }
      }

      submitButton.addEventListener("click", () => {
        setStatus("");
        handleSubmit();
      });

      plainText.addEventListener("keydown", (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          submitButton.click();
        }
      });

      clearButton.addEventListener("click", () => {
        setStatus("");
        plainText.value = "";
        resetMultiFiles();
      });

      renderResult(state.currentIndex);
    </script>
  </body>
</html>
