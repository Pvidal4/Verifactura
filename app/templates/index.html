<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifactura · Extracción y validación de facturas vehiculares</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        --accent: #2563eb;
        --accent-dark: #1e40af;
        --accent-soft: rgba(37, 99, 235, 0.12);
        --border: #e2e8f0;
        --border-strong: #cbd5f5;
        --text: #0f172a;
        --muted: #64748b;
        --surface: #ffffff;
        --surface-subtle: #f8fafc;
        --danger: #dc2626;
        --danger-soft: rgba(220, 38, 38, 0.12);
        background: var(--surface);
        color: var(--text);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--surface);
        color: var(--text);
      }

      h1,
      h2,
      h3,
      p {
        margin: 0;
      }

      button {
        font: inherit;
        cursor: pointer;
      }

      .app-shell {
        min-height: 100vh;
        padding: clamp(2.5rem, 4vw, 4rem) clamp(1.5rem, 6vw, 5rem) 3rem;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 100%;
      }

      .header-bar {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: clamp(1.5rem, 4vw, 3rem);
        flex-wrap: wrap;
      }

      .header-text {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: min(860px, 100%);
      }

      .header-extra {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 1rem;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      header h1 {
        font-size: clamp(1.85rem, 3.2vw, 3rem);
        font-weight: 600;
        letter-spacing: -0.02em;
        color: var(--text);
      }

      header p {
        color: var(--muted);
        font-size: 1rem;
        line-height: 1.6;
        max-width: 72ch;
      }

      .hero-logo {
        width: clamp(180px, 22vw, 260px);
        height: auto;
        display: block;
      }

      .developer-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-size: 0.85rem;
        font-weight: 500;
      }

      .header-restore {
        align-self: flex-start;
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 0.5rem 1.1rem;
        font-weight: 500;
        color: var(--accent);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .header-restore:hover,
      .header-restore:focus-visible {
        border-color: var(--accent);
        color: var(--accent-dark);
        box-shadow: 0 0 0 3px var(--accent-soft);
        outline: none;
      }

      .settings-button {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 0.5rem 1.1rem;
        font-weight: 500;
        color: var(--muted);
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .settings-button:hover,
      .settings-button:focus-visible {
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        outline: none;
      }

      .workspace {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        gap: 2rem;
        align-items: flex-start;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 1.5rem;
        padding: clamp(1.75rem, 2vw, 2.25rem);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        box-shadow: 0 28px 60px -40px rgba(15, 23, 42, 0.3);
      }

      .panel h2 {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text);
      }

      .panel--input {
        position: relative;
      }

      .panel-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
      }

      .panel-header__text {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .panel-body {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .panel-toggle {
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .panel-toggle:hover,
      .panel-toggle:focus-visible {
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        outline: none;
      }

      .panel-toggle span[aria-hidden="true"] {
        font-size: 1rem;
      }

      .segmented-control {
        display: inline-flex;
        align-self: flex-start;
        background: var(--surface-subtle);
        border-radius: 999px;
        padding: 0.25rem;
        border: 1px solid var(--border);
        gap: 0.25rem;
      }

      .segmented-control button {
        border: none;
        padding: 0.5rem 1.1rem;
        border-radius: 999px;
        color: var(--muted);
        background: transparent;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }

      .segmented-control button.active {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 10px 22px -16px rgba(37, 99, 235, 0.8);
      }

      .drop-zone {
        border: 1.5px dashed var(--border);
        border-radius: 1.25rem;
        padding: clamp(2rem, 4vw, 2.75rem);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.25rem;
        text-align: center;
        background: var(--surface-subtle);
        transition: border-color 0.2s ease, background 0.2s ease;
        position: relative;
      }

      .drop-zone.dragging {
        border-color: var(--accent);
        background: var(--accent-soft);
      }

      .drop-zone__icon {
        width: 64px;
        height: 64px;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0));
        display: grid;
        place-items: center;
        color: var(--accent);
        font-size: 1.75rem;
      }

      .drop-zone strong {
        font-size: 1.05rem;
      }

      .drop-zone p {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .drop-zone button {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 999px;
        padding: 0.6rem 1.4rem;
        font-weight: 500;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .drop-zone button:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .file-details {
        display: grid;
        gap: 1.25rem;
        margin-top: 1.5rem;
      }

      .file-meta {
        display: grid;
        gap: 0.75rem;
        font-size: 0.9rem;
      }

      .file-meta div {
        display: flex;
        align-items: baseline;
        gap: 0.35rem;
      }

      .file-meta span {
        color: var(--muted);
      }

      .file-meta strong {
        color: var(--text);
      }

      .preview {
        background: var(--surface-subtle);
        border: 1px solid var(--border);
        border-radius: 1.1rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .preview h3 {
        font-size: 1rem;
        font-weight: 600;
      }

      .preview-action {
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--accent);
        font-size: 0.85rem;
        font-weight: 500;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      }

      .preview-action:hover,
      .preview-action:focus-visible {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        color: var(--accent-dark);
        outline: none;
      }

      .preview-content {
        max-height: 320px;
        overflow: auto;
        border-radius: 0.75rem;
        background: var(--surface);
        border: 1px solid var(--border);
      }

      .preview-content iframe,
      .preview-content embed {
        width: 100%;
        height: 320px;
        border: none;
        border-radius: inherit;
      }

      .preview-content img {
        max-width: 100%;
        display: block;
        border-radius: inherit;
      }

      .preview-content pre {
        margin: 0;
        padding: 1rem;
        font-family: "IBM Plex Mono", "Fira Code", monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        line-height: 1.5;
      }

      .preview-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        background: rgba(15, 23, 42, 0.65);
        z-index: 1000;
      }

      .preview-modal[hidden] {
        display: none;
      }

      .preview-modal__dialog {
        width: min(960px, 95vw);
        max-height: 90vh;
        background: var(--surface);
        border-radius: 1.25rem;
        border: 1px solid var(--border);
        box-shadow: 0 40px 90px -45px rgba(15, 23, 42, 0.55);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .preview-modal__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
      }

      .preview-modal__header h3 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
      }

      .preview-modal__close {
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 1.75rem;
        line-height: 1;
        padding: 0.25rem;
        cursor: pointer;
        border-radius: 0.5rem;
      }

      .preview-modal__close:hover,
      .preview-modal__close:focus-visible {
        color: var(--text);
        background: var(--surface-subtle);
        outline: none;
      }

      .preview-modal__body {
        flex: 1;
        overflow: auto;
        background: var(--surface);
        padding: 0;
      }

      .preview-modal__body iframe,
      .preview-modal__body embed {
        width: 100%;
        min-height: 70vh;
        border: none;
      }

      .preview-modal__body img {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        height: auto;
      }

      .preview-modal__body pre {
        margin: 0;
        padding: 1.25rem;
        font-family: "IBM Plex Mono", "Fira Code", monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      body.modal-open {
        overflow: hidden;
      }

      .multi-details {
        display: grid;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .multi-summary {
        font-size: 0.9rem;
        display: inline-flex;
        align-items: baseline;
        gap: 0.35rem;
        color: var(--muted);
      }

      .multi-summary strong {
        color: var(--text);
      }

      .multi-file-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.75rem;
      }

      .multi-file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        background: var(--surface-subtle);
        border: 1px solid var(--border);
      }

      .multi-file-item span {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.9rem;
      }

      .multi-file-item small {
        color: var(--muted);
      }

      .multi-file-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .multi-file-item button.remove-button {
        border: none;
        background: transparent;
        color: var(--danger);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
      }

      .multi-file-item button.remove-button:hover,
      .multi-file-item button.remove-button:focus-visible {
        color: #b91c1c;
        outline: none;
      }

      textarea {
        width: 100%;
        border-radius: 1rem;
        border: 1px solid var(--border);
        min-height: 220px;
        padding: 1rem;
        font: inherit;
        line-height: 1.5;
        background: var(--surface-subtle);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
        background: var(--surface);
      }

      .helper-text {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
        color: var(--muted);
      }

      .toggle input[type="checkbox"] {
        appearance: none;
        width: 44px;
        height: 24px;
        border-radius: 999px;
        background: var(--border);
        position: relative;
        transition: background 0.25s ease;
      }

      .toggle input[type="checkbox"]::after {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
        transition: transform 0.25s ease;
      }

      .toggle input[type="checkbox"]:checked {
        background: var(--accent);
      }

      .toggle input[type="checkbox"]:checked::after {
        transform: translateX(20px);
      }

      .submit-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .primary {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 1rem;
        padding: 0.85rem 1.8rem;
        font-weight: 600;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }

      .primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px -20px rgba(37, 99, 235, 0.8);
      }

      .secondary {
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        border-radius: 1rem;
        padding: 0.8rem 1.2rem;
        font-weight: 500;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      .secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .status {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .status.error {
        color: var(--danger);
      }

      .results-header {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .results-header p {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .download-group {
        display: inline-flex;
        gap: 0.5rem;
      }

      .download-group button {
        border-radius: 0.9rem;
        padding: 0.65rem 1.1rem;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--muted);
        font-weight: 500;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      .download-group button:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
      }

      .download-group button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .results-navigation {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        justify-content: flex-end;
      }

      .results-navigation button {
        border: none;
        background: var(--surface-subtle);
        color: var(--accent);
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        font-weight: 500;
      }

      .result-meta {
        font-size: 0.9rem;
        color: var(--muted);
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .result-meta strong {
        color: var(--text);
      }

      .results-grid {
        display: grid;
        gap: 1rem;
        max-height: 60vh;
        overflow: auto;
        padding-right: 0.25rem;
      }

      .results-grid.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-size: 0.95rem;
        text-align: center;
      }

      .workspace--input-hidden {
        grid-template-columns: minmax(0, 1fr);
      }

      .workspace--input-hidden .panel--input {
        display: none;
      }

      .settings-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(2px);
        z-index: 300;
      }

      .settings-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: min(320px, 90vw);
        height: 100vh;
        background: var(--surface);
        border-left: 1px solid var(--border);
        box-shadow: -30px 0 60px -40px rgba(15, 23, 42, 0.35);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.25s ease;
        z-index: 400;
      }

      .settings-panel[aria-hidden="false"] {
        transform: translateX(0);
      }

      .settings-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
      }

      .settings-panel__header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .settings-close {
        border: none;
        background: transparent;
        font-size: 1.5rem;
        color: var(--muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.5rem;
      }

      .settings-close:hover,
      .settings-close:focus-visible {
        color: var(--text);
        background: var(--surface-subtle);
        outline: none;
      }

      .settings-panel__body {
        padding: 1.25rem 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        overflow-y: auto;
      }

      .settings-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .settings-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        font-size: 0.95rem;
      }

      .settings-option label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-weight: 500;
      }

      .settings-option span {
        color: var(--muted);
        font-size: 0.85rem;
        font-weight: 400;
      }

      .settings-option input[type="checkbox"] {
        width: 46px;
        height: 24px;
      }

      .settings-option select {
        border-radius: 0.75rem;
        border: 1px solid var(--border);
        padding: 0.45rem 0.75rem;
        background: var(--surface-subtle);
        font: inherit;
      }

      body.theme-dark {
        color-scheme: dark;
        --surface: #0f172a;
        --surface-subtle: #16213c;
        --border: rgba(148, 163, 184, 0.25);
        --border-strong: rgba(148, 163, 184, 0.45);
        --text: #e2e8f0;
        --muted: #cbd5f5;
        background: var(--surface);
        color: var(--text);
      }

      body.theme-dark header h1,
      body.theme-dark header p,
      body.theme-dark .panel h2,
      body.theme-dark .panel-header__text p,
      body.theme-dark .multi-summary,
      body.theme-dark .multi-file-item span,
      body.theme-dark .multi-file-item strong,
      body.theme-dark .settings-button {
        color: var(--text);
      }

      body.theme-dark .settings-button {
        border-color: var(--border-strong);
      }

      .progress-row {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 0.75rem 1rem;
      }

      .progress-row__meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .progress-track {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: var(--surface-subtle);
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        width: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        transition: width 0.3s ease;
      }

      .result-field {
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 0.9rem 1rem;
        background: var(--surface-subtle);
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .result-field label {
        font-weight: 600;
        font-size: 0.92rem;
        color: var(--text);
      }

      .result-field .value {
        font-size: 0.9rem;
        color: var(--text);
        word-break: break-word;
      }

      .result-field .value.missing {
        color: var(--danger);
        border-radius: 0.75rem;
        border: 1px dashed var(--danger);
        background: var(--danger-soft);
        padding: 0.65rem 0.75rem;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.06);
        color: var(--muted);
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
      }

      @media (max-width: 760px) {
        .app-shell {
          padding: 2rem 1.25rem 3rem;
        }

        .header-extra {
          align-items: flex-start;
          width: 100%;
        }

        .header-actions {
          align-self: flex-start;
        }

        .results-navigation {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div class="header-bar">
          <div class="header-text">
            <h1>Verifactura · Extracción y validación de facturas vehiculares</h1>
            <p>
              Carga tus comprobantes y obtén campos normalizados y validados con reglas
              SRI y VIN.
            </p>
            <span class="developer-badge" id="developerBadge" hidden>Modo desarrollador</span>
            <button
              type="button"
              id="showInputPanelButton"
              class="header-restore"
              hidden
            >
              Cargar más facturas
            </button>
          </div>
          <div class="header-extra">
            <div class="header-actions">
              <button
                type="button"
                id="settingsButton"
                class="settings-button"
                aria-haspopup="dialog"
                aria-expanded="false"
              >
                Ajustes
              </button>
            </div>
            <img
              src="{{ request.url_for('static', path='verifactura-logo.svg') }}"
              alt="VeriFactura"
              class="hero-logo"
            />
          </div>
        </div>
      </header>

      <div class="workspace">
        <section class="panel panel--input" aria-labelledby="inputHeading" id="inputPanel">
          <div class="panel-header">
            <div class="panel-header__text">
              <h2 id="inputHeading">Carga de facturas</h2>
              <p class="helper-text">
                Formatos admitidos: PDF, XML, JSON, PNG, JPG, JPEG, TIF, TIFF.
              </p>
            </div>
            <button
              type="button"
              class="panel-toggle"
              id="hideInputPanelButton"
              aria-label="Ocultar sección de carga"
              aria-pressed="false"
            >
              Ocultar
            </button>
          </div>

          <div class="panel-body" id="inputPanelBody">
            <div class="segmented-control" role="tablist">
              <button
                type="button"
                id="multiModeButton"
                class="active"
                role="tab"
                aria-selected="true"
              >
                Subir archivo
              </button>
              <button
                type="button"
                id="textModeButton"
                role="tab"
                aria-selected="false"
              >
                Ingreso manual
              </button>
            </div>

            <div id="multiMode" role="tabpanel" aria-labelledby="multiModeButton">
              <div class="drop-zone" id="multiDropZone" tabindex="0">
                <div class="drop-zone__icon">📁</div>
                <strong>Selecciona las facturas a procesar</strong>
                <p>Las facturas deben ser del mismo formato.</p>
                <button type="button" id="multiBrowseButton">Buscar archivos</button>
                <input
                  type="file"
                  id="multiFileInput"
                  accept=".pdf,.xml,.json,.png,.jpg,.jpeg,.tif,.tiff"
                  multiple
                  hidden
                />
              </div>

              <div class="multi-details" id="multiDetails" hidden>
                <div class="multi-summary">
                  <span>Tipo detectado:</span>
                  <strong id="multiTypeLabel">—</strong>
                </div>
                <div class="toggle" id="multiPdfToggleRow" hidden>
                  <input type="checkbox" id="multiPdfOcrToggle" />
                  <label for="multiPdfOcrToggle">OCR</label>
                </div>
                <ul class="multi-file-list" id="multiFileList"></ul>
                <div class="progress-row" id="multiProgress" hidden aria-live="polite">
                  <div class="progress-row__meta">
                    <span id="multiProgressText">0 de 0 facturas</span>
                    <strong id="multiProgressPercent">0%</strong>
                  </div>
                  <div
                    class="progress-track"
                    id="multiProgressTrack"
                    role="progressbar"
                    aria-valuemin="0"
                    aria-valuemax="1"
                    aria-valuenow="0"
                  >
                    <div class="progress-bar" id="multiProgressBar"></div>
                  </div>
                </div>
              </div>

              <p class="helper-text" id="multiEmptyState">
                Aún no has agregado archivos. Arrástralos o selecciónalos desde tu equipo.
              </p>
            </div>

            <div id="textMode" role="tabpanel" aria-labelledby="textModeButton" hidden>
              <textarea
                id="plainText"
                placeholder="Manualmente coloca el contenido de la factura..."
                aria-label="Contenido manual de la factura"
              ></textarea>
            </div>

            <div class="submit-row">
              <button id="submitButton" class="primary">Procesar</button>
              <button id="clearButton" class="secondary" type="button">Limpiar</button>
              <span id="statusMessage" class="status" role="status"></span>
            </div>
          </div>
        </section>

        <section class="panel" aria-labelledby="outputHeading">
          <div class="results-header">
            <div>
              <h2 id="outputHeading">Resultados</h2>
              <p id="resultsSummary">Procesa un documento para ver los campos extraídos.</p>
            </div>
            <div class="download-group">
              <button id="downloadJson" disabled>Descargar JSON</button>
              <button id="downloadCsv" disabled>Descargar CSV</button>
            </div>
          </div>

          <div class="results-navigation" id="resultsNavigation" hidden>
            <button type="button" id="prevResult">Anterior</button>
            <span id="resultPosition" class="pill"></span>
            <button type="button" id="nextResult">Siguiente</button>
          </div>

          <div class="result-meta" id="resultMeta" hidden></div>

          <div class="results-grid empty" id="resultsContainer">
            Aún no hay resultados. Procesa un documento para comenzar.
          </div>
        </section>
      </div>
    </div>

    <div id="previewModal" class="preview-modal" hidden aria-hidden="true">
      <div
        class="preview-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="previewModalTitle"
      >
        <div class="preview-modal__header">
          <h3 id="previewModalTitle">Vista previa</h3>
          <button
            type="button"
            class="preview-modal__close"
            id="previewModalClose"
            aria-label="Cerrar vista previa"
          >
            &times;
          </button>
        </div>
        <div class="preview-modal__body" id="previewModalContent"></div>
      </div>
    </div>

    <div id="settingsBackdrop" class="settings-backdrop" hidden></div>
    <aside
      id="settingsPanel"
      class="settings-panel"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-labelledby="settingsTitle"
      tabindex="-1"
    >
      <div class="settings-panel__header">
        <h3 id="settingsTitle">Ajustes</h3>
        <button type="button" id="closeSettingsButton" class="settings-close" aria-label="Cerrar ajustes">
          &times;
        </button>
      </div>
      <div class="settings-panel__body">
        <div class="settings-group">
          <div class="settings-option">
            <label for="autoClearToggle">
              Limpiar automáticamente
              <span>Vacía el formulario después de procesar.</span>
            </label>
            <input type="checkbox" id="autoClearToggle" />
          </div>
          <div class="settings-option">
            <label for="themeSelect">
              Apariencia
              <span>Selecciona modo claro u oscuro.</span>
            </label>
            <select id="themeSelect">
              <option value="light">Modo claro</option>
              <option value="dark">Modo oscuro</option>
            </select>
          </div>
          <div class="settings-option">
            <label for="developerToggle">
              Modo desarrollador
              <span>Muestra indicadores adicionales.</span>
            </label>
            <input type="checkbox" id="developerToggle" />
          </div>
        </div>
      </div>
    </aside>

    <script>
      const SUPPORTED_TYPES = {
        pdf: {
          label: "PDF",
          extensions: ["pdf"],
          endpoint: "file",
        },
        xml: {
          label: "XML",
          extensions: ["xml"],
          endpoint: "file",
        },
        json: {
          label: "JSON",
          extensions: ["json"],
          endpoint: "file",
        },
        image: {
          label: "Imagen",
          extensions: ["png", "jpg", "jpeg", "tif", "tiff"],
          endpoint: "image",
        },
      };

      const ACCEPT_STRING = Object.values(SUPPORTED_TYPES)
        .map((type) => type.extensions.map((ext) => `.${ext}`).join(","))
        .join(",");

      const state = {
        mode: "multi",
        modalPreviewUrl: null,
        multiFiles: [],
        multiCategory: null,
        multiUseOcr: false,
        results: [],
        currentIndex: -1,
        settings: {
          autoClear: true,
          theme: "light",
          developerMode: false,
        },
      };

      const previewModal = document.getElementById("previewModal");
      const previewModalContent = document.getElementById("previewModalContent");
      const previewModalClose = document.getElementById("previewModalClose");
      const submitButton = document.getElementById("submitButton");
      const clearButton = document.getElementById("clearButton");
      const statusMessage = document.getElementById("statusMessage");
      const plainText = document.getElementById("plainText");
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsSummary = document.getElementById("resultsSummary");
      const resultsNavigation = document.getElementById("resultsNavigation");
      const resultPosition = document.getElementById("resultPosition");
      const resultMeta = document.getElementById("resultMeta");
      const downloadJson = document.getElementById("downloadJson");
      const downloadCsv = document.getElementById("downloadCsv");
      const prevResultBtn = document.getElementById("prevResult");
      const nextResultBtn = document.getElementById("nextResult");
      const textMode = document.getElementById("textMode");
      const multiMode = document.getElementById("multiMode");
      const textModeButton = document.getElementById("textModeButton");
      const multiModeButton = document.getElementById("multiModeButton");
      const multiDropZone = document.getElementById("multiDropZone");
      const multiBrowseButton = document.getElementById("multiBrowseButton");
      const multiFileInput = document.getElementById("multiFileInput");
      const multiDetails = document.getElementById("multiDetails");
      const multiFileList = document.getElementById("multiFileList");
      const multiTypeLabel = document.getElementById("multiTypeLabel");
      const multiEmptyState = document.getElementById("multiEmptyState");
      const multiPdfToggleRow = document.getElementById("multiPdfToggleRow");
      const multiPdfOcrToggle = document.getElementById("multiPdfOcrToggle");
      const workspace = document.querySelector(".workspace");
      const inputPanel = document.getElementById("inputPanel");
      const inputPanelBody = document.getElementById("inputPanelBody");
      const hideInputPanelButton = document.getElementById("hideInputPanelButton");
      const showInputPanelButton = document.getElementById("showInputPanelButton");
      const multiProgress = document.getElementById("multiProgress");
      const multiProgressText = document.getElementById("multiProgressText");
      const multiProgressPercent = document.getElementById("multiProgressPercent");
      const multiProgressTrack = document.getElementById("multiProgressTrack");
      const multiProgressBar = document.getElementById("multiProgressBar");
      const settingsButton = document.getElementById("settingsButton");
      const settingsPanel = document.getElementById("settingsPanel");
      const settingsBackdrop = document.getElementById("settingsBackdrop");
      const closeSettingsButton = document.getElementById("closeSettingsButton");
      const autoClearToggle = document.getElementById("autoClearToggle");
      const themeSelect = document.getElementById("themeSelect");
      const developerToggle = document.getElementById("developerToggle");
      const developerBadge = document.getElementById("developerBadge");

      let lastFocusedElement = null;
      let lastSettingsTrigger = null;

      function setMultiPdfToggleVisibility(visible) {
        multiPdfToggleRow.hidden = !visible;
        multiPdfToggleRow.setAttribute("aria-hidden", String(!visible));
        multiPdfToggleRow.style.display = visible ? "flex" : "none";
        if (!visible) {
          state.multiUseOcr = false;
          multiPdfOcrToggle.checked = false;
        }
      }

      function applyTheme(theme) {
        document.body.classList.toggle("theme-dark", theme === "dark");
      }

      function applyDeveloperMode(enabled) {
        developerBadge.hidden = !enabled;
      }

      function syncSettingsControls() {
        autoClearToggle.checked = state.settings.autoClear;
        themeSelect.value = state.settings.theme;
        developerToggle.checked = state.settings.developerMode;
      }

      function openSettingsPanel() {
        if (settingsPanel.getAttribute("aria-hidden") === "false") {
          return;
        }
        syncSettingsControls();
        lastSettingsTrigger = document.activeElement;
        settingsPanel.setAttribute("aria-hidden", "false");
        settingsBackdrop.hidden = false;
        settingsButton.setAttribute("aria-expanded", "true");
        settingsPanel.focus({ preventScroll: true });
      }

      function closeSettingsPanel() {
        if (settingsPanel.getAttribute("aria-hidden") === "true") {
          return;
        }
        settingsPanel.setAttribute("aria-hidden", "true");
        settingsBackdrop.hidden = true;
        settingsButton.setAttribute("aria-expanded", "false");
        if (lastSettingsTrigger && typeof lastSettingsTrigger.focus === "function") {
          lastSettingsTrigger.focus({ preventScroll: true });
        }
        lastSettingsTrigger = null;
      }

      function collapseInputPanel() {
        if (workspace.classList.contains("workspace--input-hidden")) {
          return;
        }
        workspace.classList.add("workspace--input-hidden");
        inputPanel.setAttribute("aria-hidden", "true");
        inputPanelBody.setAttribute("aria-hidden", "true");
        showInputPanelButton.hidden = false;
        hideInputPanelButton.setAttribute("aria-pressed", "true");
        showInputPanelButton.focus({ preventScroll: true });
      }

      function expandInputPanel() {
        if (!workspace.classList.contains("workspace--input-hidden")) {
          return;
        }
        workspace.classList.remove("workspace--input-hidden");
        inputPanel.removeAttribute("aria-hidden");
        inputPanelBody.removeAttribute("aria-hidden");
        showInputPanelButton.hidden = true;
        hideInputPanelButton.setAttribute("aria-pressed", "false");
        hideInputPanelButton.focus({ preventScroll: true });
      }

      function resetMultiProgress() {
        multiProgress.hidden = true;
        multiProgressTrack.setAttribute("aria-valuenow", "0");
        multiProgressTrack.setAttribute("aria-valuemax", "1");
        multiProgressBar.style.width = "0%";
        multiProgressText.textContent = "0 de 0 facturas";
        multiProgressPercent.textContent = "0%";
      }

      function showMultiProgress(total) {
        multiProgress.hidden = false;
        multiProgressTrack.setAttribute("aria-valuemin", "0");
        multiProgressTrack.setAttribute("aria-valuemax", String(total));
        multiProgressTrack.setAttribute("aria-valuenow", "0");
        multiProgressBar.style.width = "0%";
        multiProgressText.textContent = `0 de ${total} facturas`;
        multiProgressPercent.textContent = "0%";
      }

      function updateMultiProgress(current, total) {
        multiProgressTrack.setAttribute("aria-valuenow", String(current));
        const percentage = total === 0 ? 0 : Math.round((current / total) * 100);
        multiProgressBar.style.width = `${percentage}%`;
        multiProgressText.textContent = `${current} de ${total} facturas`;
        multiProgressPercent.textContent = `${percentage}%`;
      }

      function closePreviewModal() {
        if (previewModal.hidden) {
          return;
        }
        previewModal.hidden = true;
        previewModal.setAttribute("aria-hidden", "true");
        if (state.modalPreviewUrl) {
          URL.revokeObjectURL(state.modalPreviewUrl);
          state.modalPreviewUrl = null;
        }
        previewModalContent.innerHTML = "";
        document.body.classList.remove("modal-open");
        if (lastFocusedElement && typeof lastFocusedElement.focus === "function") {
          lastFocusedElement.focus();
        }
        lastFocusedElement = null;
      }

      function renderModalPreview(file, category) {
        previewModalContent.innerHTML = "";
        if (!file || !category) {
          const message = document.createElement("p");
          message.style.padding = "1.25rem";
          message.textContent = "No hay vista previa disponible.";
          previewModalContent.appendChild(message);
          return;
        }

        if (category === "image" || category === "pdf") {
          if (state.modalPreviewUrl) {
            URL.revokeObjectURL(state.modalPreviewUrl);
            state.modalPreviewUrl = null;
          }
          const url = URL.createObjectURL(file);
          state.modalPreviewUrl = url;

          if (category === "image") {
            const img = document.createElement("img");
            img.src = url;
            img.alt = "Vista previa ampliada de la imagen subida";
            previewModalContent.appendChild(img);
          } else {
            const iframe = document.createElement("iframe");
            iframe.src = url;
            iframe.title = "Vista previa ampliada del PDF";
            previewModalContent.appendChild(iframe);
          }
        } else {
          if (state.modalPreviewUrl) {
            URL.revokeObjectURL(state.modalPreviewUrl);
            state.modalPreviewUrl = null;
          }
          const placeholder = document.createElement("p");
          placeholder.style.padding = "1.25rem";
          placeholder.textContent = "Cargando vista previa...";
          previewModalContent.appendChild(placeholder);
          const reader = new FileReader();
          reader.onload = () => {
            const text = reader.result || "";
            previewModalContent.innerHTML = "";
            const pre = document.createElement("pre");
            pre.textContent = String(text).slice(0, 20000);
            previewModalContent.appendChild(pre);
          };
          reader.readAsText(file, "utf-8");
        }
      }

      function showModalPreview(file, category) {
        if (!file || !category) {
          return;
        }
        renderModalPreview(file, category);
        openPreviewModal();
      }

      function openPreviewModal() {
        lastFocusedElement = document.activeElement;
        previewModal.hidden = false;
        previewModal.setAttribute("aria-hidden", "false");
        document.body.classList.add("modal-open");
        previewModalClose.focus();
      }

      previewModalClose.addEventListener("click", () => {
        closePreviewModal();
      });

      previewModal.addEventListener("click", (event) => {
        if (event.target === previewModal) {
          closePreviewModal();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") {
          return;
        }
        if (!previewModal.hidden) {
          event.preventDefault();
          closePreviewModal();
          return;
        }
        if (settingsPanel.getAttribute("aria-hidden") === "false") {
          event.preventDefault();
          closeSettingsPanel();
        }
      });

      setMultiPdfToggleVisibility(false);
      resetMultiProgress();

      hideInputPanelButton.addEventListener("click", () => {
        collapseInputPanel();
      });

      showInputPanelButton.addEventListener("click", () => {
        expandInputPanel();
      });

      settingsButton.addEventListener("click", () => {
        openSettingsPanel();
      });

      closeSettingsButton.addEventListener("click", () => {
        closeSettingsPanel();
      });

      settingsBackdrop.addEventListener("click", () => {
        closeSettingsPanel();
      });

      autoClearToggle.addEventListener("change", (event) => {
        state.settings.autoClear = event.target.checked;
      });

      themeSelect.addEventListener("change", (event) => {
        state.settings.theme = event.target.value;
        applyTheme(state.settings.theme);
      });

      developerToggle.addEventListener("change", (event) => {
        state.settings.developerMode = event.target.checked;
        applyDeveloperMode(state.settings.developerMode);
      });

      applyTheme(state.settings.theme);
      applyDeveloperMode(state.settings.developerMode);

      multiFileInput.setAttribute("accept", ACCEPT_STRING);

      function resetMultiFiles() {
        state.multiFiles = [];
        state.multiCategory = null;
        state.multiUseOcr = false;
        multiFileInput.value = "";
        multiDetails.hidden = true;
        multiEmptyState.hidden = false;
        multiFileList.innerHTML = "";
        multiTypeLabel.textContent = "—";
        setMultiPdfToggleVisibility(false);
        resetMultiProgress();
      }

      function setStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.classList.toggle("error", Boolean(isError));
      }

      function setActiveModeButton(button, isActive) {
        button.classList.toggle("active", isActive);
        button.setAttribute("aria-selected", String(isActive));
      }

      function switchMode(mode) {
        if (mode === state.mode) return;
        state.mode = mode;
        const isTextMode = mode === "text";
        const isMultiMode = mode === "multi";
        textMode.hidden = !isTextMode;
        multiMode.hidden = !isMultiMode;
        setActiveModeButton(textModeButton, isTextMode);
        setActiveModeButton(multiModeButton, isMultiMode);
        const inputHidden = workspace.classList.contains("workspace--input-hidden");
        if (isTextMode) {
          resetMultiFiles();
          if (!inputHidden) {
            plainText.focus();
          }
        } else if (!inputHidden) {
          plainText.value = "";
          multiDropZone.focus();
        }
        setStatus("");
      }

      textModeButton.addEventListener("click", () => switchMode("text"));
      multiModeButton.addEventListener("click", () => switchMode("multi"));

      function detectCategory(file) {
        const extension = (file.name.split(".").pop() || "").toLowerCase();
        const mime = (file.type || "").toLowerCase();
        if (mime.startsWith("image/")) {
          return "image";
        }
        for (const [key, info] of Object.entries(SUPPORTED_TYPES)) {
          if (info.extensions.includes(extension)) {
            return key;
          }
        }
        if (mime === "application/pdf") {
          return "pdf";
        }
        return null;
      }

      function renderMultiList() {
        if (!state.multiFiles.length) {
          resetMultiFiles();
          return;
        }
        multiDetails.hidden = false;
        multiEmptyState.hidden = true;
        const label = SUPPORTED_TYPES[state.multiCategory].label;
        const isPdfBatch = state.multiCategory === "pdf" && state.multiFiles.length > 0;
        setMultiPdfToggleVisibility(isPdfBatch);
        if (isPdfBatch) {
          multiPdfOcrToggle.checked = state.multiUseOcr;
          multiTypeLabel.textContent = `${label}${state.multiUseOcr ? " (OCR)" : ""}`;
        } else {
          multiTypeLabel.textContent = label;
        }
        multiFileList.innerHTML = "";
        state.multiFiles.forEach((entry, index) => {
          const item = document.createElement("li");
          item.className = "multi-file-item";
          const info = document.createElement("span");
          const name = document.createElement("strong");
          name.textContent = entry.file.name;
          const type = document.createElement("small");
          type.textContent =
            entry.category === "pdf" && state.multiUseOcr
              ? `${SUPPORTED_TYPES[entry.category].label} (OCR)`
              : SUPPORTED_TYPES[entry.category].label;
          info.appendChild(name);
          info.appendChild(type);
          const actions = document.createElement("div");
          actions.className = "multi-file-actions";

          const viewButton = document.createElement("button");
          viewButton.type = "button";
          viewButton.textContent = "Ver";
          viewButton.className = "preview-action";
          viewButton.setAttribute(
            "aria-label",
            `Ver ${entry.file.name} en pantalla completa`
          );
          viewButton.addEventListener("click", () => {
            showModalPreview(entry.file, entry.category);
          });

          const removeButton = document.createElement("button");
          removeButton.type = "button";
          removeButton.textContent = "×";
          removeButton.className = "remove-button";
          removeButton.setAttribute(
            "aria-label",
            `Eliminar ${entry.file.name} de la lista`
          );
          removeButton.addEventListener("click", () => {
            state.multiFiles.splice(index, 1);
            if (!state.multiFiles.length) {
              state.multiCategory = null;
              state.multiUseOcr = false;
              multiPdfOcrToggle.checked = false;
            }
            renderMultiList();
          });

          actions.appendChild(viewButton);
          actions.appendChild(removeButton);

          item.appendChild(info);
          item.appendChild(actions);
          multiFileList.appendChild(item);
        });
      }

      function handleMultiSelection(file) {
        const category = detectCategory(file);
        if (!category) {
          setStatus(`El archivo ${file.name} no es de un formato admitido.`, true);
          return;
        }
        if (state.multiCategory && state.multiCategory !== category) {
          setStatus(
            "Todos los archivos deben ser del mismo tipo para el procesamiento en lote.",
            true
          );
          return;
        }
        state.multiCategory = category;
        if (category !== "pdf") {
          setMultiPdfToggleVisibility(false);
        }
        const uploadedAt = Date.now();
        state.multiFiles.push({ file, category, uploadedAt });
        renderMultiList();
        setStatus("");
      }

      function handleMultiFileList(fileList) {
        if (!fileList || !fileList.length) {
          return;
        }
        Array.from(fileList).forEach((file) => handleMultiSelection(file));
        multiFileInput.value = "";
      }

      multiBrowseButton.addEventListener("click", () => {
        if (state.mode !== "multi") return;
        multiFileInput.click();
      });

      multiFileInput.addEventListener("change", (event) => {
        const files = event.target.files;
        handleMultiFileList(files);
      });

      multiDropZone.addEventListener("click", () => {
        if (state.mode !== "multi") return;
        multiFileInput.click();
      });

      multiDropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        if (state.mode === "multi") {
          multiDropZone.classList.add("dragging");
        }
      });

      ["dragleave", "dragend", "drop"].forEach((eventName) => {
        multiDropZone.addEventListener(eventName, () =>
          multiDropZone.classList.remove("dragging")
        );
      });

      multiDropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        if (state.mode !== "multi") {
          return;
        }
        const { files } = event.dataTransfer;
        handleMultiFileList(files);
      });

      multiPdfOcrToggle.addEventListener("change", () => {
        state.multiUseOcr = multiPdfOcrToggle.checked;
        renderMultiList();
      });

      function flattenData(data, prefix = "") {
        if (data === null || data === undefined) {
          return { [prefix.slice(0, -1)]: null };
        }
        if (typeof data !== "object") {
          return { [prefix.slice(0, -1)]: data };
        }
        if (Array.isArray(data)) {
          if (!data.length) {
            return { [prefix.slice(0, -1)]: [] };
          }
          const result = {};
          data.forEach((value, index) => {
            Object.entries(flattenData(value, `${prefix}${index}.`)).forEach(
              ([key, val]) => {
                result[key] = val;
              }
            );
          });
          return result;
        }
        const entries = Object.entries(data);
        if (!entries.length) {
          return { [prefix.slice(0, -1)]: {} };
        }
        const result = {};
        entries.forEach(([key, value]) => {
          Object.entries(flattenData(value, `${prefix}${key}.`)).forEach(([child, val]) => {
            result[child] = val;
          });
        });
        return result;
      }

      function renderResult(index) {
        if (state.results.length === 0) {
          resultsContainer.classList.add("empty");
          resultsContainer.innerHTML =
            "Aún no hay resultados. Procesa un documento para comenzar.";
          resultsSummary.textContent = "Procesa un documento para ver los campos extraídos.";
          resultsNavigation.hidden = true;
          resultMeta.hidden = true;
          downloadJson.disabled = true;
          downloadCsv.disabled = true;
          return;
        }

        const entry = state.results[index];
        const uploadedAt = entry.uploadedAt || entry.timestamp;
        resultsContainer.classList.remove("empty");
        resultsContainer.innerHTML = "";
        resultsSummary.textContent = `Última actualización: ${new Date(
          uploadedAt
        ).toLocaleString()}`;

        const flat = flattenData(entry.data);
        Object.keys(flat)
          .sort((a, b) => a.localeCompare(b))
          .forEach((key) => {
            const value = flat[key];
            const field = document.createElement("div");
            field.className = "result-field";
            const label = document.createElement("label");
            label.textContent = key || "(valor)";
            const valueElement = document.createElement("div");
            valueElement.className = "value";
            if (value === null || value === undefined || value === "" || (Array.isArray(value) && value.length === 0)) {
              valueElement.classList.add("missing");
              valueElement.textContent = "Sin valor";
            } else if (typeof value === "object") {
              valueElement.textContent = JSON.stringify(value);
            } else {
              valueElement.textContent = String(value);
            }
            field.appendChild(label);
            field.appendChild(valueElement);
            resultsContainer.appendChild(field);
          });

        resultMeta.hidden = false;
        const metaParts = [
          `<div><span class="pill">${entry.source}</span></div>`,
          `<div>Subido el <strong>${new Date(uploadedAt).toLocaleString()}</strong></div>`,
          `<div>Procesado el <strong>${new Date(entry.timestamp).toLocaleString()}</strong></div>`,
        ];
        resultMeta.innerHTML = metaParts.join("");

        resultsNavigation.hidden = state.results.length <= 1;
        resultPosition.textContent = `Documento ${index + 1} de ${state.results.length}`;
        resultPosition.setAttribute("aria-live", "polite");
        prevResultBtn.disabled = index === 0;
        nextResultBtn.disabled = index === state.results.length - 1;
        downloadJson.disabled = false;
        downloadCsv.disabled = false;
      }

      function addResultEntry(data, source, options = {}) {
        const timestamp = Date.now();
        const entry = {
          id:
            typeof crypto !== "undefined" && typeof crypto.randomUUID === "function"
              ? crypto.randomUUID()
              : Math.random().toString(36).slice(2),
          data,
          source,
          timestamp,
          uploadedAt: options.uploadedAt || timestamp,
        };
        state.results.push(entry);
        state.currentIndex = state.results.length - 1;
        renderResult(state.currentIndex);
      }

      prevResultBtn.addEventListener("click", () => {
        if (state.currentIndex > 0) {
          state.currentIndex -= 1;
          renderResult(state.currentIndex);
        }
      });

      nextResultBtn.addEventListener("click", () => {
        if (state.currentIndex < state.results.length - 1) {
          state.currentIndex += 1;
          renderResult(state.currentIndex);
        }
      });

      function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
      }

      function buildDownloadPayloads() {
        const enriched = state.results.map((entry) => ({
          id: entry.id,
          archivo: entry.source,
          subido_en: new Date((entry.uploadedAt || entry.timestamp)).toISOString(),
          procesado_en: new Date(entry.timestamp).toISOString(),
          datos: entry.data,
        }));
        return enriched;
      }

      downloadJson.addEventListener("click", () => {
        if (!state.results.length) return;
        const payload = buildDownloadPayloads();
        downloadFile(JSON.stringify(payload, null, 2), "resultados_verifactura.json", "application/json");
      });

      downloadCsv.addEventListener("click", () => {
        if (!state.results.length) return;
        const payload = buildDownloadPayloads();
        const allKeys = new Set(["id", "archivo", "subido_en", "procesado_en"]);
        payload.forEach((item) => {
          Object.keys(flattenData(item.datos)).forEach((key) => {
            if (!key) {
              allKeys.add("datos");
            } else {
              allKeys.add(`datos.${key}`);
            }
          });
        });
        const headers = Array.from(allKeys);
        const rows = payload.map((item) => {
          const flat = flattenData(item.datos);
          const values = headers.map((header) => {
            if (header === "id") return item.id;
            if (header === "archivo") return item.archivo;
            if (header === "subido_en") return item.subido_en;
            if (header === "procesado_en") return item.procesado_en;
            const key = header === "datos" ? "" : header.replace(/^datos\./, "");
            const value = Object.prototype.hasOwnProperty.call(flat, key)
              ? flat[key]
              : null;
            if (value === null || value === undefined) {
              return "";
            }
            if (typeof value === "object") {
              return JSON.stringify(value);
            }
            return String(value);
          });
          return values
            .map((value) => {
              const escaped = String(value).replace(/"/g, '""');
              return `"${escaped}"`;
            })
            .join(",");
        });
        const csv = [headers.join(","), ...rows].join("\n");
        downloadFile(csv, "resultados_verifactura.csv", "text/csv;charset=utf-8");
      });

      function validateBeforeSend() {
        if (state.mode === "text") {
          const value = plainText.value.trim();
          if (!value) {
            throw new Error("Ingresa texto para procesar.");
          }
          return { type: "text", payload: value };
        }
        if (state.mode === "multi") {
          if (!state.multiFiles.length || !state.multiCategory) {
            throw new Error("Agrega al menos un archivo para procesar en lote.");
          }
          return {
            type: "multi",
            payload: {
              category: state.multiCategory,
              entries: state.multiFiles.map((entry) => ({ ...entry })),
              useOcr: state.multiUseOcr,
            },
          };
        }
        throw new Error("Selecciona un modo de procesamiento válido.");
      }

      async function sendText(text) {
        const response = await fetch("/api/v1/extract/text", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          throw new Error(detail.detail || "No se pudo procesar el texto.");
        }
        return response.json();
      }

      async function sendFile(file, type, options = {}) {
        const { useOcr = false } = options;
        const formData = new FormData();
        formData.append("file", file);
        let endpoint = "/api/v1/extract/file";
        if (type === "image") {
          endpoint = "/api/v1/extract/image";
        } else if (type === "pdf" && useOcr) {
          endpoint = "/api/v1/extract/file?force_ocr=true";
        }
        const response = await fetch(endpoint, {
          method: "POST",
          body: formData,
        });
        if (!response.ok) {
          const detail = await response.json().catch(() => ({}));
          throw new Error(detail.detail || "No se pudo procesar el archivo.");
        }
        return response.json();
      }

      async function handleSubmit() {
        try {
          setStatus("Procesando...", false);
          submitButton.disabled = true;
          const { type, payload } = validateBeforeSend();
          if (type === "text") {
            const now = Date.now();
            const result = await sendText(payload);
            addResultEntry(result, "Ingreso manual", { uploadedAt: now });
            if (state.settings.autoClear) {
              plainText.value = "";
            }
          } else if (type === "multi") {
            const { category, entries, useOcr } = payload;
            showMultiProgress(entries.length);
            updateMultiProgress(0, entries.length);
            for (let index = 0; index < entries.length; index += 1) {
              const currentEntry = entries[index];
              setStatus(
                `Procesando factura ${index + 1} de ${entries.length}...`,
                false
              );
              const currentResult = await sendFile(currentEntry.file, category, {
                useOcr: category === "pdf" ? useOcr : false,
              });
              const label =
                category === "pdf"
                  ? `${SUPPORTED_TYPES[category].label}${useOcr ? " (OCR)" : ""}`
                  : SUPPORTED_TYPES[category].label;
              const description = `${label} · ${currentEntry.file.name}`;
              addResultEntry(currentResult, description, {
                uploadedAt: currentEntry.uploadedAt || Date.now(),
              });
              updateMultiProgress(index + 1, entries.length);
            }
            if (state.settings.autoClear) {
              resetMultiFiles();
            } else {
              renderMultiList();
            }
          }
          setStatus("¡Extracción completada!", false);
        } catch (error) {
          console.error(error);
          resetMultiProgress();
          setStatus(error.message || "No se pudo completar la solicitud.", true);
        } finally {
          submitButton.disabled = false;
        }
      }

      submitButton.addEventListener("click", () => {
        setStatus("");
        handleSubmit();
      });

      plainText.addEventListener("keydown", (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          submitButton.click();
        }
      });

      clearButton.addEventListener("click", () => {
        setStatus("");
        plainText.value = "";
        resetMultiFiles();
      });

      renderResult(state.currentIndex);
    </script>
  </body>
</html>
